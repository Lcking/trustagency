# ğŸ“Š å†…å­˜é—®é¢˜è§£å†³æ–¹æ¡ˆ - å®Œæ•´æ€»ç»“

## ğŸ”´ é—®é¢˜ç—‡çŠ¶

ä½ çš„æœåŠ¡å™¨é‡åˆ°äº† Docker æ„å»ºæ—¶çš„**å†…å­˜ä¸è¶³ (OOM)** é”™è¯¯ï¼š

```
exit code: 137
Killed
```

**åŸå› **ï¼š4GB æœåŠ¡å™¨åœ¨æ„å»ºåç«¯ Python é•œåƒæ—¶ï¼Œå†…å­˜ä¸è¶³è¢«æ€æ­»è¿›ç¨‹

---

## âœ… å·²æ¨é€çš„è§£å†³æ–¹æ¡ˆæ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶

1. **`fix-memory-error.sh`** â­ **â† æ¨èç›´æ¥ä½¿ç”¨è¿™ä¸ªï¼**
   - è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ¸…ç†å’Œä¿®å¤æ­¥éª¤
   - ä¸€é”®è§£å†³ OOM é—®é¢˜
   - åŒ…å«è¯¦ç»†çš„è¿›åº¦æç¤º

2. **`MEMORY_ERROR_QUICK_FIX.md`** â† å¿«é€Ÿå‚è€ƒæŒ‡å—
   - é—®é¢˜è¯´æ˜
   - ä¸‰ç§è§£å†³æ–¹æ¡ˆ
   - éªŒè¯æ­¥éª¤
   - å¸¸è§é—®é¢˜

3. **`FIX_MEMORY_ERROR.md`** â† è¯¦ç»†è¯Šæ–­æŒ‡å—
   - å®Œæ•´çš„æŠ€æœ¯åˆ†æ
   - å„ç§ä¿®å¤æ–¹æ¡ˆè¯¦è§£
   - ç³»ç»Ÿä¼˜åŒ–å»ºè®®
   - ç´§æ€¥åº”å¯¹æªæ–½

---

## ğŸš€ ç°åœ¨åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ

### ç¬¬1æ­¥ï¼šæ‹‰å–æœ€æ–°ä»£ç 

```bash
cd /opt/trustagency
git pull origin main
```

### ç¬¬2æ­¥ï¼šæ‰§è¡Œå†…å­˜ä¿®å¤è„šæœ¬

```bash
bash fix-memory-error.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨ï¼š**
- âœ… åœæ­¢ç°æœ‰å®¹å™¨
- âœ… æ¸…ç† Docker èµ„æºå’Œæ„å»ºç¼“å­˜
- âœ… é‡æ–°æ„å»ºå’Œå¯åŠ¨æ‰€æœ‰å®¹å™¨
- âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€
- âœ… æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€

### ç¬¬3æ­¥ï¼šç­‰å¾…å®Œæˆï¼ˆçº¦ 10-15 åˆ†é’Ÿï¼‰

è„šæœ¬ä¼šæ˜¾ç¤ºè¯¦ç»†çš„è¿›åº¦ï¼š

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ Docker å†…å­˜ä¸è¶³ä¿®å¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š å½“å‰ç³»ç»ŸçŠ¶æ€
å¯ç”¨å†…å­˜: ... GB
...

ğŸ§¹ æ­¥éª¤ 1/4: åœæ­¢ç°æœ‰å®¹å™¨...
âœ… å®¹å™¨å·²åœæ­¢

ğŸ§¹ æ­¥éª¤ 2/4: æ¸…ç† Docker èµ„æº...
âœ… Docker èµ„æºå·²æ¸…ç†

ğŸš€ æ­¥éª¤ 3/4: é‡æ–°å¯åŠ¨å®¹å™¨...
  è¿™ä¸€æ­¥å¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ...

ğŸ” æ­¥éª¤ 4/4: éªŒè¯éƒ¨ç½²...
...

âœ… ä¿®å¤å®Œæˆï¼
```

---

## âœ… æˆåŠŸçš„æ ‡å¿—

è„šæœ¬æ‰§è¡Œå®Œåï¼ŒæŸ¥çœ‹ï¼š

```bash
# 1. å®¹å™¨çŠ¶æ€ï¼ˆåº”è¯¥éƒ½æ˜¯ Up æˆ– healthyï¼‰
docker-compose -f docker-compose.prod.yml ps

# 2. API æµ‹è¯•ï¼ˆåº”è¯¥è¿”å› {"status": "ok"}ï¼‰
curl http://localhost:8001/health
```

å¦‚æœéƒ½æˆåŠŸï¼Œè¯´æ˜ **OOM é—®é¢˜å·²è§£å†³ï¼** ğŸ‰

---

## ğŸ†˜ å¦‚æœè„šæœ¬è¿˜æ˜¯å¤±è´¥

### æ–¹æ¡ˆ1ï¼šæ‰‹åŠ¨å¿«é€Ÿä¿®å¤

```bash
cd /opt/trustagency

# åœæ­¢å’Œæ¸…ç†
docker-compose -f docker-compose.prod.yml down
docker system prune -a -f
docker builder prune -a -f

# é‡æ–°å¯åŠ¨
docker-compose --env-file .env.prod -f docker-compose.prod.yml up -d

# ç­‰å¾… 10-15 åˆ†é’Ÿï¼Œç„¶åéªŒè¯
docker-compose -f docker-compose.prod.yml ps
```

### æ–¹æ¡ˆ2ï¼šæ›´æ¿€è¿›çš„æ¸…ç†

```bash
cd /opt/trustagency

# åœæ­¢å®¹å™¨
docker-compose -f docker-compose.prod.yml down

# åˆ é™¤æ‰€æœ‰é•œåƒå’Œå·
docker rmi -f $(docker images -q)
docker volume prune -f

# ç³»ç»Ÿæ¸…ç†
docker system prune -a -f

# é‡æ–°å¯åŠ¨
bash fix-memory-error.sh
```

### æ–¹æ¡ˆ3ï¼šä¸´æ—¶å¢åŠ  Swapï¼ˆåº”æ€¥ï¼‰

```bash
# åˆ›å»º 2GB Swap æ–‡ä»¶
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# éªŒè¯
free -h

# é‡æ–°è¿è¡Œä¿®å¤è„šæœ¬
bash fix-memory-error.sh
```

---

## ğŸ“Š è¯Šæ–­å’Œç›‘æ§

### æŸ¥çœ‹å½“å‰èµ„æºä½¿ç”¨

```bash
# å†…å­˜
free -h

# ç£ç›˜ç©ºé—´
df -h /

# Docker ä½¿ç”¨æƒ…å†µ
docker system df

# è¿è¡Œä¸­çš„è¿›ç¨‹
top -b -n 1 | head -10
```

### å®æ—¶ç›‘æ§æ„å»ºè¿‡ç¨‹

åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œï¼š

```bash
# ç›‘æ§å†…å­˜å’Œå®¹å™¨
watch -n 1 'free -h && echo "---" && docker stats --no-stream'
```

---

## ğŸ¯ ä¸‰ç§è§£å†³æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ–¹æ³• | è€—æ—¶ | éš¾åº¦ | æˆåŠŸç‡ |
|------|------|------|------|--------|
| **æ¨è** | æ‰§è¡Œ `fix-memory-error.sh` | 10-15 åˆ†é’Ÿ | æç®€ï¼ˆä¸€æ¡å‘½ä»¤ï¼‰ | 85%+ |
| å¤‡é€‰1 | æ‰‹åŠ¨æ¸…ç†åé‡å¯ | 10-15 åˆ†é’Ÿ | ç®€å•ï¼ˆ5æ¡å‘½ä»¤ï¼‰ | 80% |
| å¤‡é€‰2 | æ¿€è¿›æ¸…ç† | 15-20 åˆ†é’Ÿ | ç®€å• | 90% |
| åº”æ€¥ | å¢åŠ  Swap + é‡è¯• | 20-30 åˆ†é’Ÿ | ä¸­ç­‰ | 95% |

---

## ğŸ“š å®Œæ•´æ–‡æ¡£ä½ç½®

åœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹ï¼š

```bash
# å¿«é€Ÿå‚è€ƒ
cat /opt/trustagency/MEMORY_ERROR_QUICK_FIX.md

# è¯¦ç»†æŒ‡å—
cat /opt/trustagency/FIX_MEMORY_ERROR.md
```

---

## ğŸ”— æ ¸å¿ƒå‘½ä»¤é€ŸæŸ¥

```bash
# ã€æœ€ç®€å•ã€‘ä¸€é”®ä¿®å¤
bash fix-memory-error.sh

# ã€æ‰‹åŠ¨æ¸…ç†ã€‘3 æ¡å‘½ä»¤
docker-compose -f docker-compose.prod.yml down
docker system prune -a -f
docker-compose --env-file .env.prod -f docker-compose.prod.yml up -d

# ã€éªŒè¯ã€‘æ£€æŸ¥éƒ¨ç½²
docker-compose -f docker-compose.prod.yml ps
curl http://localhost:8001/health

# ã€è¯Šæ–­ã€‘æŸ¥çœ‹èµ„æº
free -h
df -h /
docker system df
```

---

## â±ï¸ é¢„è®¡æ—¶é—´è¡¨

- **æ¸…ç†é˜¶æ®µ**ï¼š1-2 åˆ†é’Ÿ
- **Docker èµ„æºæ¸…ç†**ï¼š1-2 åˆ†é’Ÿ
- **é•œåƒæ„å»º**ï¼š5-10 åˆ†é’Ÿ
- **å®¹å™¨å¯åŠ¨**ï¼š2-3 åˆ†é’Ÿ
- **éªŒè¯**ï¼š1-2 åˆ†é’Ÿ
- **æ€»è®¡**ï¼š10-15 åˆ†é’Ÿ

---

## ğŸ‰ ä¿®å¤å®Œæˆå

1. **è®¿é—®åå°ç®¡ç†ç³»ç»Ÿ**
   ```
   http://your-domain.com/admin/
   ç”¨æˆ·å: admin
   å¯†ç : admin123
   ```

2. **ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ** âš ï¸

3. **é…ç½® HTTPS å’Œå¤‡ä»½**ï¼ˆå¯é€‰ï¼‰

---

## ğŸ’¡ ä¸ºä»€ä¹ˆä¼šå‡ºç° OOMï¼Ÿ

### åŸå› åˆ†æ

1. **4GB å†…å­˜ä¸è¶³**
   - æ“ä½œç³»ç»Ÿï¼š~500MB
   - Docker é•œåƒåŸºç¡€å±‚ï¼š~1GB
   - Python ä¾èµ–å®‰è£…ï¼š~800MB
   - æ€»è®¡éœ€æ±‚ï¼š> 2GB

2. **æ„å»ºè¿‡ç¨‹èµ„æºå¯†é›†**
   - ä¸‹è½½å¤§é‡ Python åŒ…
   - ç¼–è¯‘æŸäº›éœ€è¦ç¼–è¯‘çš„åŒ…
   - ä¸´æ—¶æ–‡ä»¶å †ç§¯

3. **æ²¡æœ‰ Swap ç©ºé—´**
   - å½“ç‰©ç†å†…å­˜æ»¡æ—¶æ— æ³•æº¢å‡º
   - è¿›ç¨‹è¢« OOM Killer æ€æ­»

### è§£å†³æ€è·¯

- æ¸…ç†æ„å»ºç¼“å­˜é‡Šæ”¾ç©ºé—´
- åˆ é™¤æ—§é•œåƒå’Œå·
- ä½¿ç”¨é¢„æ„å»ºé•œåƒè·³è¿‡æœ¬åœ°æ„å»º
- å¢åŠ  Swap ä½œä¸ºåº”æ€¥

---

## âœ¨ æ¨èæµç¨‹

### å¿«é€Ÿä¿®å¤ï¼ˆæ¨èï¼‰

```bash
cd /opt/trustagency && bash fix-memory-error.sh
```

### å¦‚æœè¿˜æ˜¯å¤±è´¥

```bash
# æ›´æ¿€è¿›çš„æ¸…ç†
docker-compose -f docker-compose.prod.yml down
docker rmi -f $(docker images -q)
docker volume prune -f
docker system prune -a -f

# é‡è¯•
bash fix-memory-error.sh
```

### æœ€åçš„æ‰‹æ®µ

```bash
# ä¸´æ—¶å¢åŠ  Swap
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# é‡è¯•
bash fix-memory-error.sh
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

1. **æŸ¥çœ‹è‡ªåŠ¨ä¿®å¤è„šæœ¬çš„è¾“å‡º**
   ```bash
   bash fix-memory-error.sh 2>&1 | tee repair.log
   ```

2. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
   ```bash
   docker-compose -f docker-compose.prod.yml logs backend | tail -100
   ```

3. **æ£€æŸ¥èµ„æºä½¿ç”¨**
   ```bash
   free -h && df -h / && docker system df
   ```

---

**ç°åœ¨å°±åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¿®å¤å§ï¼**

```bash
cd /opt/trustagency && bash fix-memory-error.sh
```

**ç¥ä¿®å¤é¡ºåˆ©ï¼ğŸš€**
