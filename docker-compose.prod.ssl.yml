# Docker Compose SSL Override for Production
# 
# Usage (after setting up SSL certificates):
#   docker-compose -f docker-compose.prod.yml -f docker-compose.prod.ssl.yml up -d
#
# Prerequisites:
#   1. First-time certificate setup (stop nginx first):
#      docker-compose -f docker-compose.prod.yml down frontend
#      certbot certonly --standalone -d yycr.net -d www.yycr.net
#      docker-compose -f docker-compose.prod.yml -f docker-compose.prod.ssl.yml up -d
#
#   2. Set up automatic renewal cron job (runs twice daily as Let's Encrypt recommends):
#      Replace PROJECT_PATH with your actual deployment path (e.g., /opt/trustagency)
#
#      Since we use standalone mode, nginx must be stopped during renewal.
#      Use --pre-hook to stop nginx before renewal and --post-hook to restart after:
#
#      (crontab -l 2>/dev/null; echo "0 3,15 * * * certbot renew --quiet \
#        --pre-hook 'docker-compose -f PROJECT_PATH/docker-compose.prod.yml -f PROJECT_PATH/docker-compose.prod.ssl.yml stop frontend' \
#        --post-hook 'docker-compose -f PROJECT_PATH/docker-compose.prod.yml -f PROJECT_PATH/docker-compose.prod.ssl.yml start frontend'") | crontab -
#
#      Example for /opt/trustagency (single line):
#      (crontab -l 2>/dev/null; echo "0 3,15 * * * certbot renew --quiet --pre-hook 'docker-compose -f /opt/trustagency/docker-compose.prod.yml -f /opt/trustagency/docker-compose.prod.ssl.yml stop frontend' --post-hook 'docker-compose -f /opt/trustagency/docker-compose.prod.yml -f /opt/trustagency/docker-compose.prod.ssl.yml start frontend'") | crontab -
#
# Note: 
#   - --pre-hook and --post-hook only run when certificates actually need renewal
#   - Nginx will have brief downtime (~seconds) during actual certificate renewal
#   - Certificates are mounted from Let's Encrypt and auto-update after nginx restart

version: '3.8'

services:
  frontend:
    volumes:
      # Override: Use SSL-enabled nginx config
      - ./nginx/ssl.conf:/etc/nginx/conf.d/default.conf:ro
      # Security headers (required by location blocks)
      - ./nginx/security-headers.conf:/etc/nginx/conf.d/security-headers.conf:ro
      # Mount only the specific certificate directories (principle of least privilege)
      # live/ contains symlinks pointing to archive/, so both are needed
      - /etc/letsencrypt/live/yycr.net:/etc/letsencrypt/live/yycr.net:ro
      - /etc/letsencrypt/archive/yycr.net:/etc/letsencrypt/archive/yycr.net:ro

