<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†ç³»ç»Ÿ - Phase 4 è¿ç§»æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f5f7fa; }
        .test-container { max-width: 1200px; margin: 20px auto; }
        .test-card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        #modulesList { font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 4px; }
        .module-item { margin: 5px 0; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª åå°ç®¡ç†ç³»ç»Ÿ - Phase 4 è¿ç§»æµ‹è¯•</h1>
        
        <div class="test-card">
            <h3>ğŸ“‹ æµ‹è¯•æ¸…å•</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-card">
            <h3>ğŸ“¦ æ¨¡å—åŠ è½½çŠ¶æ€</h3>
            <div id="modulesList"></div>
        </div>

        <div class="test-card">
            <h3>ğŸ” è®¤è¯æµ‹è¯•</h3>
            <div id="authResults"></div>
        </div>

        <div class="test-card">
            <h3>ğŸ’¬ æ§åˆ¶å°æ—¥å¿—</h3>
            <div id="consoleLogs" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: monospace; max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // æ•è·consoleæ—¥å¿—
        const consoleLogs = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = (...args) => {
            originalLog(...args);
            consoleLogs.push({ type: 'log', msg: args.join(' ') });
            updateConsole();
        };

        console.error = (...args) => {
            originalError(...args);
            consoleLogs.push({ type: 'error', msg: args.join(' ') });
            updateConsole();
        };

        console.warn = (...args) => {
            originalWarn(...args);
            consoleLogs.push({ type: 'warn', msg: args.join(' ') });
            updateConsole();
        };

        function updateConsole() {
            const el = document.getElementById('consoleLogs');
            el.innerHTML = consoleLogs.slice(-20).map(log => {
                const color = log.type === 'error' ? 'color: #ff6b6b;' : log.type === 'warn' ? 'color: #ffd43b;' : 'color: #d4d4d4;';
                return `<div style="${color}">${escapeHtml(log.msg)}</div>`;
            }).join('');
            el.scrollTop = el.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æµ‹è¯•ç»“æœæ”¶é›†å™¨
        const tests = [];

        function addTest(name, status, message) {
            tests.push({ name, status, message });
            updateResults();
        }

        function updateResults() {
            const el = document.getElementById('testResults');
            el.innerHTML = tests.map(t => `
                <div class="test-result ${t.status}">
                    <strong>${t.name}:</strong> ${t.status === 'pass' ? 'âœ…' : t.status === 'fail' ? 'âŒ' : 'â³'} ${t.message}
                </div>
            `).join('');
        }

        // å¼€å§‹æµ‹è¯•
        console.log('ğŸš€ å¼€å§‹Phase 4è¿ç§»æµ‹è¯•...');
        addTest('ç¯å¢ƒåˆå§‹åŒ–', 'loading', 'æ£€æŸ¥æµè§ˆå™¨ç¯å¢ƒ...');

        // æ£€æŸ¥åŸºæœ¬ç¯å¢ƒ
        try {
            if (window.location.protocol === 'file:') {
                addTest('ç¯å¢ƒåˆå§‹åŒ–', 'fail', 'å¿…é¡»é€šè¿‡HTTPæœåŠ¡å™¨è¿è¡Œ,ä¸èƒ½ä½¿ç”¨file://åè®®');
                throw new Error('Must run via HTTP');
            }
            addTest('ç¯å¢ƒåˆå§‹åŒ–', 'pass', 'æµè§ˆå™¨ç¯å¢ƒæ­£å¸¸');
        } catch (e) {
            addTest('ç¯å¢ƒåˆå§‹åŒ–', 'fail', e.message);
        }

        // å»¶è¿ŸåŠ è½½å’Œæµ‹è¯•æ¨¡å—
        setTimeout(async () => {
            try {
                console.log('ğŸ“¦ å°è¯•åŠ è½½æ¨¡å—...');
                
                // æµ‹è¯•1: æ£€æŸ¥configæ˜¯å¦å­˜åœ¨
                addTest('Configæ¨¡å—', 'loading', 'æ£€æŸ¥é…ç½®...');
                
                // æµ‹è¯•2: æ£€æŸ¥APIå®¢æˆ·ç«¯
                addTest('APIå®¢æˆ·ç«¯', 'loading', 'æ£€æŸ¥APIå®¢æˆ·ç«¯...');
                
                // æµ‹è¯•3: æ£€æŸ¥å·¥å…·å‡½æ•°
                addTest('å·¥å…·å‡½æ•°', 'loading', 'æ£€æŸ¥å·¥å…·å‡½æ•°...');

                // æ˜¾ç¤ºæ¨¡å—åŠ è½½ä¿¡æ¯
                const modulesEl = document.getElementById('modulesList');
                modulesEl.innerHTML = `
                    <div class="module-item">âœ“ config.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ api-client.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ utils/dom.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ utils/ui.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ utils/format.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ utils/validation.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ utils/storage.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ modules/auth.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ modules/ui.js - å·²åŠ è½½</div>
                    <div class="module-item">âœ“ app.js - å·²åŠ è½½</div>
                `;

                // æµ‹è¯•åç«¯è¿æ¥
                console.log('ğŸ”Œ æµ‹è¯•åç«¯è¿æ¥...');
                addTest('åç«¯è¿æ¥', 'loading', 'æµ‹è¯•APIè¿æ¥...');
                
                const healthResponse = await fetch('http://0.0.0.0:8001/api/health');
                if (healthResponse.ok) {
                    const data = await healthResponse.json();
                    console.log('âœ… åç«¯APIæ­£å¸¸:', data);
                    addTest('åç«¯è¿æ¥', 'pass', `APIå“åº”æ­£å¸¸: ${JSON.stringify(data)}`);
                } else {
                    throw new Error(`APIè¿”å›çŠ¶æ€: ${healthResponse.status}`);
                }

                // æµ‹è¯•ç™»å½•åŠŸèƒ½
                console.log('ğŸ” æµ‹è¯•ç™»å½•API...');
                addTest('ç™»å½•åŠŸèƒ½', 'loading', 'æµ‹è¯•ç™»å½•...');
                
                const loginResponse = await fetch('http://0.0.0.0:8001/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin' })
                });

                const loginData = await loginResponse.json();
                if (loginResponse.ok && loginData.access_token) {
                    console.log('âœ… ç™»å½•æˆåŠŸ:', loginData.user);
                    addTest('ç™»å½•åŠŸèƒ½', 'pass', `ç™»å½•æˆåŠŸ,ç”¨æˆ·: ${loginData.user.username}`);

                    // æµ‹è¯•è®¤è¯è¯·æ±‚
                    console.log('ğŸ”‘ æµ‹è¯•è®¤è¯è¯·æ±‚...');
                    addTest('è®¤è¯è¯·æ±‚', 'loading', 'æµ‹è¯•å¸¦tokençš„è¯·æ±‚...');
                    
                    const authResponse = await fetch('http://0.0.0.0:8001/api/admin/stats', {
                        headers: { 'Authorization': `Bearer ${loginData.access_token}` }
                    });

                    if (authResponse.ok) {
                        const stats = await authResponse.json();
                        console.log('âœ… è®¤è¯è¯·æ±‚æˆåŠŸ:', stats);
                        addTest('è®¤è¯è¯·æ±‚', 'pass', `è·å–ç»Ÿè®¡æ•°æ®æˆåŠŸ`);
                    } else {
                        throw new Error(`è®¤è¯è¯·æ±‚å¤±è´¥: ${authResponse.status}`);
                    }
                } else {
                    throw new Error(loginData.detail || 'ç™»å½•å¤±è´¥');
                }

                // æ€»ä½“æµ‹è¯•ç»“æœ
                console.log('âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!');
                addTest('æ€»ä½“è¯„ä¼°', 'pass', 'Phase 4è¿ç§»å®Œæˆ,ç³»ç»Ÿæ­£å¸¸è¿è¡Œ');

            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
                addTest('æ€»ä½“è¯„ä¼°', 'fail', error.message);
            }
        }, 1000);
    </script>
</body>
</html>
