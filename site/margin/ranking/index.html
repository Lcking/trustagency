<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- Primary Meta Tags -->
    <title>ä¸¤èæ’è¡Œæ¦œ - èèµ„å‡€ä¹°å…¥/èåˆ¸ä½™é‡æ’å | é¹°çœ¼æŸ¥è</title>
    <meta name="title" content="ä¸¤èæ’è¡Œæ¦œ - èèµ„å‡€ä¹°å…¥/èåˆ¸ä½™é‡æ’å | é¹°çœ¼æŸ¥è">
    <meta name="description" content="Aè‚¡ä¸¤èæ’è¡Œæ¦œï¼Œå®æ—¶æŸ¥çœ‹èèµ„å‡€ä¹°å…¥TOP50ã€èåˆ¸ä½™é‡TOP50æ’åï¼ŒæŒæ¡å¸‚åœºèµ„é‡‘æµå‘å’Œåšç©ºåŠ¨å‘ã€‚">
    <meta name="keywords" content="ä¸¤èæ’è¡Œæ¦œ,èèµ„å‡€ä¹°å…¥æ’å,èåˆ¸ä½™é‡æ’å,ä¸¤èé¾™è™æ¦œ,èèµ„ä¹°å…¥TOP">
    <meta name="robots" content="index, follow">
    <meta name="author" content="é¹°çœ¼æŸ¥è">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.yycr.net/margin/ranking/">
    <meta property="og:title" content="ä¸¤èæ’è¡Œæ¦œ - èèµ„å‡€ä¹°å…¥/èåˆ¸ä½™é‡æ’å">
    <meta property="og:description" content="Aè‚¡ä¸¤èæ’è¡Œæ¦œï¼Œå®æ—¶æŸ¥çœ‹èèµ„å‡€ä¹°å…¥TOP50ã€èåˆ¸ä½™é‡TOP50æ’å">
    <meta property="og:locale" content="zh_CN">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://www.yycr.net/margin/ranking/">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <!-- Main Stylesheet -->
    <link href="/assets/css/main.css" rel="stylesheet">
    <link href="/assets/css/utilities.css" rel="stylesheet">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {"@type": "ListItem", "position": 1, "name": "é¦–é¡µ", "item": "https://www.yycr.net/"},
            {"@type": "ListItem", "position": 2, "name": "ä¸¤èæ•°æ®", "item": "https://www.yycr.net/margin/"},
            {"@type": "ListItem", "position": 3, "name": "æ’è¡Œæ¦œ", "item": "https://www.yycr.net/margin/ranking/"}
        ]
    }
    </script>

    <style>
        /* ä¸å…¶ä»–é¡µé¢ä¿æŒä¸€è‡´çš„ Hero æ ·å¼ */
        .hero-margin {
            background: linear-gradient(135deg, var(--primary-color, #0d6efd) 0%, #0b5ed7 100%);
            color: white;
            padding: 3rem 0;
        }
        .hero-margin h1 {
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .hero-margin .lead {
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .hero-margin .date-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: inline-block;
            font-size: 0.9rem;
        }
        
        /* æ ‡ç­¾åˆ‡æ¢ */
        .tab-pills {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tab-pills .btn {
            border-radius: 50px;
            padding: 0.5rem 1.25rem;
            font-weight: 500;
        }
        
        /* æ’è¡Œè¡¨æ ¼ */
        .ranking-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .ranking-table th {
            background: #f8f9fa;
            font-weight: 600;
            border: none;
        }
        .ranking-table td {
            vertical-align: middle;
        }
        .rank-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .rank-badge.rank-1 { background: linear-gradient(135deg, #ffd700, #ffb800); color: #5a4a00; }
        .rank-badge.rank-2 { background: linear-gradient(135deg, #e8e8e8, #c0c0c0); color: #444; }
        .rank-badge.rank-3 { background: linear-gradient(135deg, #deb887, #cd7f32); color: #fff; }
        .rank-badge.rank-default { background: #e9ecef; color: #495057; }
        
        .stock-link {
            color: #333;
            text-decoration: none;
            font-weight: 500;
        }
        .stock-link:hover {
            color: var(--primary-color, #0d6efd);
        }
        .stock-code {
            color: #999;
            font-size: 0.85rem;
        }
        .value-positive { color: #dc3545; }
        .value-negative { color: #28a745; }
    </style>
</head>
<body>
    
    <!-- Header / Navigation -->
    <header role="banner">
        <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top border-bottom" role="navigation" aria-label="ä¸»å¯¼èˆª">
            <div class="container">
                <a class="navbar-brand fw-bold" href="/" aria-label="é¹°çœ¼æŸ¥èé¦–é¡µ">
                    <img src="/assets/images/logo.png" alt="é¹°çœ¼æŸ¥è" class="navbar-logo">
                    <span>é¹°çœ¼</span><span class="d-none d-sm-inline">æŸ¥è</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆªèœå•">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/">é¦–é¡µ</a></li>
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="/margin/">ä¸¤è</a></li>
                        <li class="nav-item"><a class="nav-link" href="/platforms/">å¹³å°</a></li>
                        <li class="nav-item"><a class="nav-link" href="/compare/">å¯¹æ¯”</a></li>
                        <li class="nav-item"><a class="nav-link" href="/qa/">å¸¸è§é—®é¢˜</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">èµ„æº</a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/wiki/">ç™¾ç§‘</a></li>
                                <li><a class="dropdown-item" href="/guides/">æŒ‡å—</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/about/">å…³äº</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Breadcrumb -->
    <nav aria-label="é¢åŒ…å±‘å¯¼èˆª" class="bg-light py-2 border-bottom">
        <div class="container">
            <ol class="breadcrumb mb-0 small">
                <li class="breadcrumb-item"><a href="/">é¦–é¡µ</a></li>
                <li class="breadcrumb-item"><a href="/margin/">ä¸¤èæ•°æ®</a></li>
                <li class="breadcrumb-item active" aria-current="page">æ’è¡Œæ¦œ</li>
            </ol>
        </div>
    </nav>

    <main role="main">
        <!-- Hero Section -->
        <section class="hero-margin" aria-labelledby="hero-title">
            <div class="container text-center">
                <h1 id="hero-title" class="display-5 fw-bold mb-3">ğŸ† ä¸¤èæ’è¡Œæ¦œ</h1>
                <p class="lead mb-4">å®æ—¶è¿½è¸ªå¸‚åœºèµ„é‡‘æµå‘ï¼Œæ´å¯Ÿå¤šç©ºåŠ›é‡å¯¹æ¯”</p>
                <div class="date-badge" id="dataDate">
                    ğŸ“… æ•°æ®æ—¥æœŸï¼šåŠ è½½ä¸­...
                </div>
            </div>
        </section>

        <!-- Tab Selection -->
        <section class="py-4 bg-white border-bottom">
            <div class="container">
                <div class="tab-pills">
                    <button class="btn btn-primary" data-order="net_buy" onclick="switchTab(event, 'net_buy')">
                        ğŸ’° èèµ„å‡€ä¹°å…¥
                    </button>
                    <button class="btn btn-outline-secondary" data-order="rqyl" onclick="switchTab(event, 'rqyl')">
                        ğŸ“‰ èåˆ¸ä½™é‡
                    </button>
                    <button class="btn btn-outline-secondary" data-order="rzye" onclick="switchTab(event, 'rzye')">
                        ğŸ’µ èèµ„ä½™é¢
                    </button>
                    <button class="btn btn-outline-secondary" data-order="rqye" onclick="switchTab(event, 'rqye')">
                        ğŸ“Š èåˆ¸ä½™é¢
                    </button>
                </div>
            </div>
        </section>

        <!-- Ranking Table -->
        <section class="py-5">
            <div class="container">
                <div class="card ranking-table">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="rankingTable">
                            <thead>
                                <tr>
                                    <th style="width: 70px;">æ’å</th>
                                    <th>è‚¡ç¥¨</th>
                                    <th class="text-end" id="valueHeader">èèµ„å‡€ä¹°å…¥</th>
                                    <th class="text-end d-none d-md-table-cell">èèµ„ä½™é¢</th>
                                    <th class="text-end d-none d-lg-table-cell">èåˆ¸ä½™é‡</th>
                                    <th class="text-end d-none d-lg-table-cell">ä¸¤èä½™é¢</th>
                                </tr>
                            </thead>
                            <tbody id="rankingBody">
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                        </div>
                                        <p class="mt-2 text-muted mb-0">åŠ è½½ä¸­...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-5" role="contentinfo">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <h5 class="fw-bold mb-3">å…³äºæˆ‘ä»¬</h5>
                    <p class="text-muted small">é¹°çœ¼æŸ¥èä¸ºæŠ•èµ„è€…æä¾›ä¸“ä¸šçš„ä¸¤èæ•°æ®å’Œæ æ†å¹³å°ä¿¡æ¯æœåŠ¡ã€‚</p>
                </div>
                <div class="col-md-4 mb-4">
                    <h5 class="fw-bold mb-3">å¿«é€Ÿé“¾æ¥</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="/margin/" class="text-muted text-decoration-none small">ä¸¤èæ•°æ®</a></li>
                        <li class="mb-2"><a href="/platforms/" class="text-muted text-decoration-none small">å¹³å°åˆ—è¡¨</a></li>
                        <li class="mb-2"><a href="/compare/" class="text-muted text-decoration-none small">å¹³å°å¯¹æ¯”</a></li>
                        <li class="mb-2"><a href="/about/" class="text-muted text-decoration-none small">å…³äºæˆ‘ä»¬</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-4">
                    <h5 class="fw-bold mb-3">è”ç³»æˆ‘ä»¬</h5>
                    <p class="text-muted small">ğŸ“§ Email: support@yycr.net</p>
                </div>
            </div>
            <hr class="border-secondary">
            <p class="text-center text-muted small mb-0">Â© 2025 ä¸Šæµ·è–é›…å¾ä¿¡ã€‚ç‰ˆæƒæ‰€æœ‰ã€‚</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <script>
        // API åŸºç¡€ URL
        const configuredBase = window.API_BASE ?? '';
        const API_BASE = configuredBase !== ''
            ? configuredBase
            : (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:8001'
                : '');
        
        let currentOrder = 'net_buy';

        // ä» URL è·å–æ’åºç±»å‹
        function getOrderFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const queryOrder = urlParams.get('order');
            if (queryOrder && ['net_buy', 'rqyl', 'rzye', 'rqye'].includes(queryOrder)) {
                return queryOrder;
            }
            const pathMatch = window.location.pathname.match(/\/margin\/ranking\/(net_buy|rqyl|rzye|rqye)\/?$/);
            if (pathMatch) return pathMatch[1];
            return 'net_buy';
        }
        
        currentOrder = getOrderFromUrl();

        // æ ¼å¼åŒ–é‡‘é¢
        function formatAmount(value) {
            if (value === null || value === undefined) return '--';
            const yi = value / 1e8;
            if (Math.abs(yi) >= 10000) return (yi / 10000).toFixed(2) + 'ä¸‡äº¿';
            if (Math.abs(yi) >= 1) return yi.toFixed(2) + 'äº¿';
            return (value / 10000).toFixed(0) + 'ä¸‡';
        }

        // æ ¼å¼åŒ–è‚¡æ•°
        function formatVolume(value) {
            if (value === null || value === undefined) return '--';
            const wan = value / 10000;
            if (Math.abs(wan) >= 10000) return (wan / 10000).toFixed(2) + 'äº¿è‚¡';
            return wan.toFixed(0) + 'ä¸‡è‚¡';
        }

        // è·å–æ’åæ ·å¼
        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-default';
        }

        // è·å–è¡¨å¤´
        function getValueHeader(order) {
            const headers = { 'net_buy': 'èèµ„å‡€ä¹°å…¥', 'rqyl': 'èåˆ¸ä½™é‡', 'rzye': 'èèµ„ä½™é¢', 'rqye': 'èåˆ¸ä½™é¢' };
            return headers[order] || 'æ•°å€¼';
        }

        // è·å–æ’åºå€¼
        function getValue(item, order) {
            switch (order) {
                case 'net_buy': return (item.rzmre || 0) - (item.rzche || 0);
                case 'rqyl': return item.rqyl || 0;
                case 'rzye': return item.rzye || 0;
                case 'rqye': return item.rqye || 0;
                default: return 0;
            }
        }

        // æ ¼å¼åŒ–æ˜¾ç¤ºå€¼
        function formatValue(item, order) {
            const value = getValue(item, order);
            return order === 'rqyl' ? formatVolume(value) : formatAmount(value);
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(event, order) {
            currentOrder = order;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-pills .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-secondary');
            });
            event.target.classList.remove('btn-outline-secondary');
            event.target.classList.add('btn-primary');
            
            // æ›´æ–°è¡¨å¤´
            document.getElementById('valueHeader').textContent = getValueHeader(order);
            
            // æ›´æ–° URL
            window.history.replaceState({}, '', `/margin/ranking/${order}/`);
            
            // é‡æ–°åŠ è½½æ•°æ®
            loadRanking();
        }

        // åŠ è½½æ’è¡Œæ¦œæ•°æ®
        async function loadRanking() {
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2 text-muted mb-0">åŠ è½½ä¸­...</p>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch(`${API_BASE}/api/margin/ranking?order_by=${currentOrder}&limit=50`);
                if (!response.ok) throw new Error('API request failed');
                
                const result = await response.json();
                
                // æ›´æ–°æ—¥æœŸ
                if (result.trade_date) {
                    document.getElementById('dataDate').textContent = `ğŸ“… æ•°æ®æ—¥æœŸï¼š${result.trade_date}`;
                }
                
                // è·å–æ•°æ®æ•°ç»„
                const data = result.data || result.items || result;
                
                if (!data || !Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">æš‚æ— æ•°æ®</td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map((item, index) => {
                    const rank = index + 1;
                    const value = getValue(item, currentOrder);
                    const valueClass = currentOrder === 'net_buy' ? (value >= 0 ? 'value-positive' : 'value-negative') : '';
                    const stockCode = (item.ts_code || '').replace('.SH', '').replace('.SZ', '').replace('.BJ', '');
                    
                    return `
                        <tr style="cursor: pointer;" onclick="window.location.href='/margin/stock/${item.ts_code}/'">
                            <td>
                                <span class="rank-badge ${getRankClass(rank)}">${rank}</span>
                            </td>
                            <td>
                                <span class="stock-link">${item.name || stockCode}</span>
                                <br>
                                <span class="stock-code">${item.ts_code}</span>
                            </td>
                            <td class="text-end ${valueClass}">${formatValue(item, currentOrder)}</td>
                            <td class="text-end d-none d-md-table-cell">${formatAmount(item.rzye)}</td>
                            <td class="text-end d-none d-lg-table-cell">${formatVolume(item.rqyl)}</td>
                            <td class="text-end d-none d-lg-table-cell">${formatAmount(item.rzrqye)}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load ranking:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5 text-danger">
                            åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•<br>
                            <small class="text-muted">${error.message}</small>
                        </td>
                    </tr>
                `;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®åˆå§‹æ´»åŠ¨æ ‡ç­¾
            document.querySelectorAll('.tab-pills .btn').forEach(btn => {
                if (btn.dataset.order === currentOrder) {
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-primary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-secondary');
                }
            });
            
            // æ›´æ–°è¡¨å¤´
            document.getElementById('valueHeader').textContent = getValueHeader(currentOrder);
            
            // åŠ è½½æ•°æ®
            loadRanking();
        });
    </script>
</body>
</html>
