# TrustAgency 项目质量保证体系

**版本**：1.0  
**发布日期**：2025-11-21  
**状态**：生效  
**维护者**：技术委员会

---

## 📋 文档导航

本项目已建立完整的质量保证体系，包含以下核心文档：

### 1️⃣ 编码规范文档
📄 **文件**：`CODING_STANDARDS.md`  
**目的**：规范所有开发人员的代码风格和结构  
**包含内容**：
- JavaScript/HTML 规范（脚本块、事件处理、API 调用等）
- Python 后端规范（文件结构、命名、错误处理等）
- 数据库规范（模型定义、初始化等）
- Git 工作流规范（分支管理、提交格式）
- 新功能开发检查清单

**强制执行**：是 ✅  
**违规处理**：见"违规处理"部分

---

### 2️⃣ 集成测试指南
📄 **文件**：`INTEGRATION_TESTS.md`  
**目的**：确保每个功能都经过充分测试  
**包含内容**：
- 测试框架和工具设置
- 基础集成测试（登录、API 可用性）
- 功能集成测试（完整工作流）
- 回归测试（防止功能破坏）
- 性能测试

**运行方式**：
```bash
pytest tests/ -m integration -v
```

**要求**：所有 PR 合并前必须通过

---

### 3️⃣ 代码审查流程
📄 **文件**：`CODE_REVIEW_PROCESS.md`  
**目的**：建立规范的代码审查流程  
**包含内容**：
- PR 提交规范
- 审查清单（10 个关键检查点）
- 常见问题检查
- 审查反馈模板
- 审查员指导

**强制执行**：是 ✅  
**要求**：每个 PR 都必须通过至少 1 位审查员的审查

---

### 4️⃣ 根本原因分析报告
📄 **文件**：`ROOT_CAUSE_ANALYSIS.md`  
**目的**：记录历史问题和解决方案  
**包含内容**：
- 系统崩溃的根本原因
- 版本演变分析
- 架构脆弱性分析
- 改进建议

**参考用途**：学习失败案例，防止重复

---

### 5️⃣ 开发流程评审
📄 **文件**：`DEVELOPMENT_PROCESS_REVIEW.md`  
**目的**：反思"打补丁"开发模式的问题  
**包含内容**：
- 开发模式问题诊断
- 技术债积累分析
- 改进方案详细说明
- 成功指标定义

**参考用途**：团队讨论和改进方向

---

## 🎯 质量保证流程

### 完整工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                    功能需求确认                               │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│            第1步：架构设计 & 影响评估                         │
│  - 检查是否影响脚本块结构                                   │
│  - 检查是否影响 HTML 布局                                   │
│  - 检查是否引入新依赖                                       │
│  - 制定集成测试计划                                         │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│         第2步：功能实现 (遵循编码规范)                       │
│  - 创建功能分支 feature/xxx                                 │
│  - 编写代码 (遵循 CODING_STANDARDS.md)                     │
│  - 本地测试验证                                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│        第3步：本地测试 & 规范检查                            │
│  ✓ 功能完整性测试                                           │
│  ✓ 集成测试通过                                             │
│  ✓ 脚本块检查 (grep "<script>")                            │
│  ✓ HTML 标签平衡检查                                        │
│  ✓ 没有 console 错误                                        │
│  ✓ 没有 inline event handlers                              │
│  ✓ 提交信息格式正确                                         │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│         第4步：提交 PR (填写完整信息)                        │
│  - PR 标题遵循格式: type(scope): subject                    │
│  - PR 描述包含规范检查清单                                  │
│  - 选择合适的审查员                                         │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│        第5步：自动检查 (GitHub Actions)                     │
│  ✓ 代码风格检查                                             │
│  ✓ 单元测试                                                 │
│  ✓ 集成测试                                                 │
│  ✓ 代码覆盖率                                               │
└────────────────────────┬────────────────────────────────────┘
                         │
                  ✅ 通过 / ❌ 失败
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
    自动通过                         修复问题
    继续流程                         重新提交
         │                               │
         └───────────────┬───────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│        第6步：代码审查 (人工审查)                            │
│  审查员检查：                                                │
│  ✓ 代码规范性                                               │
│  ✓ 脚本块完整性 (强制)                                      │
│  ✓ HTML 结构 (强制)                                         │
│  ✓ API 调用规范 (强制)                                      │
│  ✓ 错误处理                                                 │
│  ✓ 功能完整性                                               │
│  ✓ 测试覆盖                                                 │
└────────────────────────┬────────────────────────────────────┘
                         │
              ✅ 通过 / 🔴 需要修改
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
    继续合并                        修改反馈
    流程                            重新审查
         │                               │
         └───────────────┬───────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│          第7步：合并到 dev 分支                              │
│  - 自动删除功能分支                                         │
│  - 触发 dev 分支的自动化测试                                │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│        第8步：部署前验证 & 集成测试                          │
│  - dev 分支完整集成测试                                     │
│  - 所有新功能兼容性测试                                     │
│  - 性能基准测试                                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                  ✅ 通过 / ❌ 失败
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
    创建 Release               回到 dev 分支
    合并到 main                修复问题
         │                      │
         └───────────────┬──────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│        第9步：生产环境部署 & 监控                            │
│  - 部署到生产环境                                           │
│  - 监控系统运行状态                                         │
│  - 收集用户反馈                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📋 核心规则速查表

### 🚨 强制规则（违反即拒绝合并）

| 规则 | 检查方法 | 修复方法 |
|------|--------|--------|
| **脚本块 <= 2** | `grep -c "<script>" admin/index.html` | 合并所有脚本到主块中 |
| **脚本块在 </body> 前** | `grep -n "<script>" admin/index.html` | 将脚本移到 </body> 前 |
| **HTML 标签平衡** | div 开闭数相同 | 找到未闭合的标签并修复 |
| **无 inline handlers** | `grep "onclick\|onchange"` | 改用 addEventListener |
| **使用 authenticatedFetch** | `grep "fetch(" \| grep -v "authenticated"` | 改为 authenticatedFetch |
| **API URL 用 getAPIUrl()** | `grep "http://localhost"` | 改用 getAPIUrl() 函数 |
| **使用 ORM (Python)** | `grep "SELECT.*FROM"` | 改用 SQLAlchemy |
| **Commit 信息格式** | `git log --oneline` | 改为 type(scope): subject |

---

### ✅ 推荐规则（强烈建议遵循）

| 规则 | 检查方法 | 修复方法 |
|------|--------|--------|
| **函数命名** | camelCase (JS) / snake_case (Python) | 重命名函数 |
| **错误处理** | 每个 try-catch 都有 console 输出 | 添加错误处理 |
| **测试覆盖** | `pytest --cov` | 编写缺失的测试 |
| **文档注释** | 主要函数都有注释 | 添加 JSDoc 或 docstring |
| **性能优化** | 没有 N+1 查询 | 优化数据库查询 |

---

## 🔄 分支管理规范

```
main (生产分支)
  │
  ├─ dev (开发分支)
  │   │
  │   ├─ feature/new-feature-1
  │   │
  │   ├─ feature/new-feature-2
  │   │
  │   ├─ bugfix/issue-1
  │   │
  │   └─ bugfix/issue-2
  │
  └─ hotfix/critical-bug (紧急修复)
```

**规则**：
- `main`：生产分支，受保护，只接受来自 `dev` 的合并
- `dev`：开发分支，集成所有功能，稳定但不一定完美
- `feature/*`：功能分支，从 `dev` 创建
- `bugfix/*`：修复分支，从 `dev` 创建
- `hotfix/*`：紧急修复，从 `main` 创建，修复后合并回 `main` 和 `dev`

---

## 📊 质量指标

### 目标指标

| 指标 | 当前 | 目标 | 检查方式 |
|------|------|------|--------|
| 系统可用性 | 60% | 99%+ | 监控仪表板 |
| 测试覆盖率 | - | 80%+ | `pytest --cov` |
| Bug 修复时间 | 2-3h | < 30min | 记录修复时间 |
| PR 审查时间 | 1-2d | < 4h | GitHub metrics |
| 代码规范违规 | 多 | 0 | 自动检查 |
| 集成测试通过率 | 70% | 100% | CI/CD 报告 |

---

## 📚 知识库

### 常见问题（Q&A）

**Q: 如果我不小心违反了规则怎么办？**  
A: 不用担心，这就是代码审查的目的。审查员会在审查时指出，你修改后重新提交即可。重复多次违规会对 commit 权限有影响。

**Q: 脚本块为什么最多 2 个？**  
A: 因为分割的脚本块会导致函数定义顺序混乱，容易出现"函数未定义"的错误。这就是我们为什么回滚了之前的版本。

**Q: 如果我的功能跨越多个文件怎么办？**  
A: 仍然遵循相同的规则。在代码审查过程中，审查员会检查所有修改的文件是否符合规范。

**Q: 我想修改现有功能，需要创建新分支吗？**  
A: 是的，即使修改现有功能也要创建 bugfix 分支，这样便于追踪和回滚。

**Q: 如何快速检查我的代码是否符合规范？**  
A: 运行这些命令：
```bash
# 检查脚本块
grep -c "<script>" backend/site/admin/index.html

# 检查 HTML 标签
echo "Open: $(grep -o '<div' backend/site/admin/index.html | wc -l), Close: $(grep -o '</div>' backend/site/admin/index.html | wc -l)"

# 检查 inline handlers
grep "onclick\|onchange" backend/site/admin/index.html

# 检查 commit 信息
git log --oneline -5
```

---

## 🎓 团队培训

### 新成员入门检查清单

- [ ] 已读 CODING_STANDARDS.md
- [ ] 已读 INTEGRATION_TESTS.md
- [ ] 已读 CODE_REVIEW_PROCESS.md
- [ ] 已理解脚本块规则（为什么最多 2 个）
- [ ] 已理解 PR 流程
- [ ] 已学会基本的 git 命令
- [ ] 已配置开发环境
- [ ] 已通过代码风格检查工具 (如 eslint)
- [ ] 已运行过集成测试
- [ ] 已提交过第一个 PR

---

## 🚀 后续改进计划

### 短期（1-2 周）
- [ ] 配置 GitHub Actions 自动检查
- [ ] 配置 Husky 的 pre-commit hooks
- [ ] 创建 ESLint 配置文件
- [ ] 创建 Pylint 配置文件

### 中期（2-4 周）
- [ ] 集成 SonarQube 进行代码质量分析
- [ ] 添加性能基准测试
- [ ] 建立测试数据库和 fixtures
- [ ] 创建 API 文档 (Swagger)

### 长期（1-2 个月）
- [ ] 建立安全审查检查清单
- [ ] 添加 E2E 测试
- [ ] 建立灾备流程
- [ ] 定期（每月）审查和更新规范

---

## 📞 支持和反馈

### 如有问题或建议

1. **紧急问题**：直接联系架构团队负责人
2. **改进建议**：提交 Issue 或在团队讨论中提出
3. **规范更新**：每个季度进行一次评审

---

## 签名

本文档由技术委员会制定和维护。

- 起草者：GitHub Copilot
- 审核者：待确认
- 批准者：待确认
- 生效日期：2025-11-21

**最后更新**：2025-11-21

---

## 附录：相关文档列表

| 文档 | 用途 | 频率 |
|------|------|------|
| CODING_STANDARDS.md | 编码规范 | 每个 PR 必读 |
| INTEGRATION_TESTS.md | 测试指南 | 每个 PR 前运行 |
| CODE_REVIEW_PROCESS.md | 审查流程 | 每个 PR 必经 |
| ROOT_CAUSE_ANALYSIS.md | 历史分析 | 参考/学习 |
| DEVELOPMENT_PROCESS_REVIEW.md | 流程反思 | 参考/改进 |
