# 🗺️ TrustAgency 后续发展路线图

**版本**: 1.0  
**日期**: 2025-11-23  
**当前状态**: Phase 4 完成 + 5个Bug验收通过 ✅  
**当前分支**: `refactor/admin-panel-phase4`

---

## 📋 核心原则

基于最近的事故教训，后续工作遵循以下核心原则：

1. **数据安全第一** - 所有操作必须考虑数据备份和恢复机制
2. **渐进式优化** - 避免一次性大重构，采用小步快速迭代
3. **稳定性优于性能** - 宁可功能稍慢，也要确保系统可靠
4. **充分的测试覆盖** - 每个功能变更前后都要测试
5. **自动化监控告警** - 及时发现问题，避免卡顿积累

---

## 🎯 Phase 5: 系统稳定性加固 (优先级: **最高**)

**目标**: 消除系统不稳定因素，建立可靠的运维体系  
**周期**: 2-3周  
**成功指标**: 系统连续运行72小时无卡顿，无数据异常

### 任务 5.1: 系统性能诊断和优化

**子任务**:
- [ ] **5.1.1** 深度分析内存泄漏
  - 使用 Chrome DevTools Memory Profiler 记录15分钟使用过程
  - 生成 3 份快照 (10分钟间隔)，对比增长曲线
  - 标记出内存占用的热点函数
  - **预期输出**: `MEMORY_PROFILING_REPORT.md`

- [ ] **5.1.2** 前端资源加载优化
  - 分析 Tiptap 和其他 CDN 库的加载性能
  - 实现资源预加载策略
  - 添加加载进度条反馈
  - **预期输出**: 优化后页面首屏时间 < 3s

- [ ] **5.1.3** 后端响应时间分析
  - 添加 API 响应时间中间件
  - 识别瓶颈接口 (响应 > 1s)
  - 为慢查询添加索引或缓存
  - **预期输出**: 所有API响应 < 500ms

- [ ] **5.1.4** 数据库查询优化
  - 分析 SQLite 查询日志
  - 为常用查询创建索引
  - 实现查询结果缓存 (Redis/内存)
  - **预期输出**: `DATABASE_OPTIMIZATION_REPORT.md`

**风险防控**:
```bash
# 每次优化前创建数据库备份
cp trustagency.db "backups/trustagency_backup_$(date +%Y%m%d_%H%M%S).db"

# 每次优化后运行验证
python3 -c "
import sqlite3
conn = sqlite3.connect('trustagency.db')
c = conn.cursor()
c.execute('SELECT COUNT(*) FROM articles')
print(f'articles表: {c.fetchone()[0]}条记录')
"
```

---

### 任务 5.2: 前端模块化重构的完善

**当前状态**: 模块已创建但导出/全局作用域桥接不完整

**子任务**:
- [ ] **5.2.1** 建立全局 API 暴露机制
  - 创建 `window.AppAPI` 对象，暴露所有公共函数
  - 为每个模块创建导出列表
  - 添加调试模式验证所有函数可用
  - **代码位置**: `backend/site/admin/js/bridge.js` (新建)

- [ ] **5.2.2** 模块加载失败降级处理
  - 检测 ES6 import 是否成功
  - 如失败，加载备用内联脚本
  - 添加错误告知用户的 toast 提示
  - **预期输出**: 系统始终可用，即使模块加载失败

- [ ] **5.2.3** 单元测试覆盖关键模块
  - 为 `auth.js` 编写单元测试
  - 为 `api-client.js` 编写集成测试
  - 目标覆盖率: 80%
  - **测试框架**: Jest 或 Vitest

- [ ] **5.2.4** 清理代码中的临时修复
  - 整理 `index.html` 中的备用脚本
  - 移除重复的缓存破坏器标记
  - 规范化事件处理器命名
  - **预期输出**: HTML 文件不超过 2000 行

**验收标准**:
```javascript
// 浏览器控制台应该能访问所有API
console.log(window.AppAPI.auth.login)        // ✅ function
console.log(window.AppAPI.ui.showModal)      // ✅ function
console.log(window.AppAPI.api.getArticles)   // ✅ function
```

---

### 任务 5.3: 建立自动化监控和告警系统

**目标**: 及时发现系统异常，防止事故恶化

**子任务**:
- [ ] **5.3.1** 前端性能监控
  - 实现页面加载时间统计
  - 监控 API 调用失败率
  - 添加内存占用告警 (> 200MB)
  - **工具**: 自定义 JS 监控，上报到后端

- [ ] **5.3.2** 后端健康检查
  - 创建 `/api/health` 端点 (响应 < 100ms)
  - 定期检查数据库连接
  - 验证核心表的行数变化
  - **脚本**: `backend/health_check.py`

- [ ] **5.3.3** 自动备份系统
  - 实现每 6 小时自动备份数据库
  - 保留最近 7 天的备份
  - 定期测试备份可恢复性
  - **脚本**: `backend/auto_backup.py`

- [ ] **5.3.4** 日志收集和分析
  - 统一日志格式 (时间戳、级别、模块、消息)
  - 后端日志写入 `logs/app.log`
  - 前端错误上报到后端
  - **分析工具**: 简单的日志查询页面

**部署方式**:
```bash
# 启动后端监控
nohup python3 backend/health_check.py > /tmp/health_check.log 2>&1 &

# 启动自动备份
nohup python3 backend/auto_backup.py > /tmp/backup.log 2>&1 &

# 验证运行
ps aux | grep -E "health_check|auto_backup"
```

---

## 🔧 Phase 6: 功能完善和性能优化 (优先级: **高**)

**目标**: 在系统稳定的基础上，增加缺失功能和优化用户体验  
**周期**: 3-4周  
**前置条件**: Phase 5 完成

### 任务 6.1: 完善 AI 任务系统

**当前状态**: 基础架构已建，缺少批量生成和监控界面

**子任务**:
- [ ] **6.1.1** 实现批量文章生成队列
  - 后端支持批量提交生成任务
  - 任务进度实时推送 (WebSocket 或 Server-Sent Events)
  - 支持任务暂停、恢复、取消操作

- [ ] **6.1.2** 构建任务监控仪表板
  - 显示任务队列状态 (待处理/运行中/已完成)
  - 任务详细日志查看
  - 失败任务重试机制

- [ ] **6.1.3** 集成多种 AI 模型
  - 支持切换 OpenAI、DeepSeek、Azure OpenAI
  - 实现模型成本计费记录
  - 支持自定义提示词模板

### 任务 6.2: 文章管理功能增强

**子任务**:
- [ ] **6.2.1** 富文本编辑器完善
  - 支持文章模板
  - 支持内容版本历史
  - 支持批量导入/导出

- [ ] **6.2.2** SEO 优化工具
  - 自动生成 Meta 描述
  - 关键词密度分析
  - 自动生成 Open Graph 标签

- [ ] **6.2.3** 文章发布工作流
  - 草稿 → 审核 → 发布 的三阶段流程
  - 自动发布时间设置
  - 定时撤稿功能

### 任务 6.3: 用户和权限管理

**子任务**:
- [ ] **6.3.1** 多用户支持
  - 支持创建编辑/审核/管理员角色
  - 基于角色的功能可见性控制 (RBAC)
  - 操作审计日志

- [ ] **6.3.2** 权限细粒度控制
  - 支持按栏目/分类分配权限
  - 支持内容审核权限

---

## 📊 Phase 7: 部署和规模化 (优先级: **中**)

**目标**: 为生产环境部署做准备  
**周期**: 2周  
**前置条件**: Phase 5 和 Phase 6 完成

### 任务 7.1: 生产环境部署方案

**子任务**:
- [ ] **7.1.1** Docker 容器化
  - 完善 Dockerfile (后端 + 数据库)
  - 编写 docker-compose.prod.yml
  - 配置环境变量管理 (.env.prod)

- [ ] **7.1.2** Nginx 反向代理配置
  - 配置 HTTPS/SSL
  - 设置缓存策略
  - 配置 CORS

- [ ] **7.1.3** 数据库迁移策略
  - 从 SQLite 到 PostgreSQL 的迁移脚本
  - 支持零停机迁移

- [ ] **7.1.4** 备灾方案
  - 每日备份到云存储 (AWS S3 / 阿里云 OSS)
  - 支持一键恢复
  - 多区域备份冗余

### 任务 7.2: 性能和安全加固

**子任务**:
- [ ] **7.2.1** 安全审计
  - 检查 SQL 注入风险
  - 检查 XSS 风险
  - 检查 CSRF 防护
  - **工具**: OWASP ZAP 或 Burp Suite

- [ ] **7.2.2** 密钥和敏感信息管理
  - 支持从环境变量读取密钥
  - 实现密钥轮换机制
  - 支持密钥加密存储

- [ ] **7.2.3** 速率限制和 DDoS 防护
  - 添加 API 速率限制
  - 添加登录防暴力破解
  - Nginx 配置 DDoS 防护

---

## 🧪 Phase 8: 测试和质量保证 (贯穿所有阶段)

**目标**: 确保代码质量和系统可靠性

### 任务 8.1: 自动化测试框架

**子任务**:
- [ ] **8.1.1** 后端单元测试
  - API 端点测试覆盖率 > 80%
  - 数据库操作测试
  - 工具: pytest

- [ ] **8.1.2** 前端集成测试
  - 关键页面流程测试
  - 工具: Playwright 或 Cypress
  - 覆盖率 > 70%

- [ ] **8.1.3** E2E 验收测试
  - 完整业务流程测试
  - 包括 5 个 Bug Fix 的回归测试

- [ ] **8.1.4** 性能基准测试
  - 页面加载时间基准 (< 3s)
  - API 响应时间基准 (< 500ms)
  - 并发压力测试 (支持 100+ 并发)

### 任务 8.2: 代码审查和文档

**子任务**:
- [ ] **8.2.1** 建立 Code Review 流程
  - 所有 PR 需要至少 1 人审查
  - 定期代码质量审计

- [ ] **8.2.2** 完善项目文档
  - API 文档 (Swagger/OpenAPI)
  - 部署文档
  - 故障排查指南
  - 架构设计文档

---

## ⚠️ 关键风险和防控措施

| 风险 | 可能性 | 影响 | 防控措施 |
|------|--------|------|---------|
| 模块加载失败导致功能瘫痪 | 高 | 严重 | 实现降级方案 (5.2.2) |
| 数据库损坏或丢失 | 中 | 严重 | 自动备份系统 (5.3.3) |
| 性能不达预期 | 中 | 中等 | 早期性能监控 (5.3.1) |
| 模块导出不完整导致功能不可用 | 中 | 中等 | 彻底的全局API暴露 (5.2.1) |
| 部署到生产环境后出现问题 | 中 | 严重 | 分阶段灰度发布 |

---

## 📅 时间规划表

```
11月23日   ✅ Phase 4完成 + 5个Bug验收通过
11月23日   🟡 本阶段: 规划 Phase 5-8
11月24-26日 ⏳ Phase 5.1: 性能诊断 (3天)
11月27-28日 ⏳ Phase 5.2: 模块完善 (2天)
11月29-30日 ⏳ Phase 5.3: 监控系统 (2天)
12月1-7日  ⏳ Phase 6.1-6.3: 功能完善 (7天)
12月8-14日 ⏳ Phase 7.1-7.2: 部署准备 (7天)
12月15-21日 ⏳ Phase 8: 测试完善 (7天)
12月22日   🎯 目标: 生产环境就绪
```

---

## 🚀 立即行动清单 (第一天)

为了避免重蹈覆辙，建议先完成以下快速验证:

```bash
# 1. 验证系统稳定性
cd /Users/ck/Desktop/Project/trustagency
bash start-backend-simple.sh
sleep 5

# 2. 检查数据库完整性
sqlite3 trustagency.db "SELECT '栏目数' as 类型, COUNT(*) FROM sections UNION ALL SELECT '分类数', COUNT(*) FROM categories UNION ALL SELECT '平台数', COUNT(*) FROM platforms"

# 3. 测试API
curl -s http://localhost:8001/api/sections | python3 -m json.tool | head -20

# 4. 验证前端
curl -s http://localhost:8001/admin/ | grep -o "Tiptap\|editor\|栏目" | head -5

# 5. 创建一键恢复备份
cp trustagency.db backups/baseline_$(date +%Y%m%d).db
git add backups/
git commit -m "backup: 建立baseline备份点 - Phase 5前的系统检查点"

echo "✅ 系统检查完成，准备进入Phase 5"
```

---

## 📞 问题处理流程

如果遇到新问题:

1. **首先检查**: 
   - 后端日志: `tail -f /tmp/backend.log`
   - 浏览器控制台: F12 → Console
   - 数据库完整性: `sqlite3 trustagency.db ".tables"`

2. **立即备份**:
   ```bash
   cp trustagency.db "backups/issue_$(date +%s).db"
   ```

3. **创建 Issue 文档**:
   - 问题描述
   - 复现步骤
   - 错误日志
   - 系统状态快照

4. **提交修复 PR**:
   - 分支名: `fix/issue-<描述>`
   - 必须包括单元测试
   - 必须包括回归测试

---

## 总结

这份路线图的核心思想是:

✅ **稳定性优先** - 3周打造系统基础  
✅ **小步快速迭代** - 避免大风险  
✅ **自动化保护** - 监控、备份、测试  
✅ **充分的防护网** - 降级、告警、恢复  

按照这个计划，预计 12 月中旬可以达到**生产环境就绪**的状态。

---

**最后的话**: 
> "软件开发中最昂贵的不是添加功能，而是修复因为捷径而导致的问题。" 
> 
> 这次事故是个教训，让我们一起构建一个更稳定、更可靠的系统。 ✨

