# 栏目分类体系重构 - Kanban 任务卡

## 史诗: 栏目分类体系完整重构

**目标**: 建立清晰的内容分类体系，支持栏目→分类→文章的分层管理，以及灵活的AI生成任务流程

**优先级**: 🔴 高  
**预计总工时**: 12-16h  
**状态**: 📋 规划中  

---

## Task A-15.1: 数据库表结构设计与创建

**类型**: Backend / Database  
**优先级**: 🔴 高 (阻塞其他任务)  
**预计工时**: 2-3h  
**状态**: 🟡 待启动  

### 子任务

- [ ] A-15.1.1: 创建 `sections` 表
  - 字段: id, name, slug, description, icon, requires_platform, sort_order, is_active, created_at
  - 约束: name UNIQUE, slug UNIQUE
  - 示例数据: 常见问题, 百科, 指南, 验证记录

- [ ] A-15.1.2: 改造 `categories` 表
  - 新增: section_id (FK)
  - 修改: 复合唯一约束 (section_id, name)
  - 迁移现有数据

- [ ] A-15.1.3: 改造 `articles` 表
  - 新增: section_id (FK)
  - 改造: category → category_id (FK)
  - 修改: platform_id 为可选 (NULL 当 section != "验证记录")
  - 数据迁移脚本

- [ ] A-15.1.4: 改造 `ai_generation_tasks` 表
  - 新增字段:
    - section_id, category_id (FK)
    - api_endpoint, api_key (加密), request_body (JSON)
    - error_message, started_at, completed_at
  - 改造: status 为 ENUM, progress 范围 0-100

- [ ] A-15.1.5: 创建数据库迁移脚本
  - 向前兼容性
  - 回滚方案
  - 数据验证

**验收标准**:
- ✅ 所有表结构正确创建
- ✅ 约束、索引、外键正确
- ✅ 样本数据成功插入
- ✅ 迁移脚本可正向/反向执行

**阻塞任务**: A-15.2, A-15.3, A-15.4

---

## Task A-15.2: 后端 API - 栏目管理 CRUD

**类型**: Backend / API  
**优先级**: 🔴 高  
**依赖**: A-15.1  
**预计工时**: 1.5-2h  
**状态**: 🟡 待启动  

### 需求

实现完整的栏目 (Section) CRUD API

### 子任务

- [ ] A-15.2.1: 创建 `Section` Pydantic Schema
  - SectionCreate, SectionUpdate, SectionResponse, SectionListResponse

- [ ] A-15.2.2: 创建 `SectionService` 业务逻辑层
  - create_section, get_section, list_sections, update_section, delete_section

- [ ] A-15.2.3: 创建 `sections.py` 路由
  ```
  GET    /api/sections              - 获取所有栏目 (分页)
  GET    /api/sections/{id}         - 获取栏目详情
  POST   /api/sections              - 创建栏目 (admin only)
  PUT    /api/sections/{id}         - 更新栏目 (admin only)
  DELETE /api/sections/{id}         - 删除栏目 (admin only)
  ```

- [ ] A-15.2.4: 添加权限检查
  - 只有 admin 可以进行 CRUD 操作
  - 创建时检查 name/slug 唯一性

- [ ] A-15.2.5: 编写单元测试
  - 创建、读取、更新、删除流程
  - 权限检查
  - 边界情况 (重复名称、非法数据等)

**验收标准**:
- ✅ 所有 API 端点可用
- ✅ 返回正确的状态码和响应格式
- ✅ 权限检查工作正常
- ✅ 单元测试覆盖率 > 90%

**相关文件**:
- backend/app/models/section.py (新建)
- backend/app/schemas/section.py (新建)
- backend/app/services/section_service.py (新建)
- backend/app/routes/sections.py (新建)

---

## Task A-15.3: 后端 API - 分类管理 CRUD (改造)

**类型**: Backend / API  
**优先级**: 🔴 高  
**依赖**: A-15.1, A-15.2  
**预计工时**: 2-2.5h  
**状态**: 🟡 待启动  

### 需求

改造现有 Category API，添加 section 关联和过滤

### 子任务

- [ ] A-15.3.1: 改造 `Category` Pydantic Schema
  - 新增: section_id 字段
  - CategoryCreate/Update 时验证 section 存在

- [ ] A-15.3.2: 改造 `CategoryService`
  - create_category: 检查 section 存在，检查 (section_id, name) 唯一
  - list_categories: 支持按 section_id 过滤
  - update_category: 禁止修改 section_id

- [ ] A-15.3.3: 改造路由 - 添加新端点
  ```
  GET    /api/categories                   - 获取所有分类
  GET    /api/categories/by-section/{id}  - 按栏目获取分类 (*)
  GET    /api/categories/{id}             - 获取分类详情
  POST   /api/categories                  - 创建分类
  PUT    /api/categories/{id}             - 更新分类
  DELETE /api/categories/{id}             - 删除分类
  ```

- [ ] A-15.3.4: 添加数据验证
  - section_id 必须指向有效的栏目
  - (section_id, name) 必须唯一
  - 删除时检查是否有关联文章

- [ ] A-15.3.5: 编写单元测试
  - 按栏目过滤
  - 唯一性约束
  - 级联删除检查

**验收标准**:
- ✅ 分类可按栏目过滤
- ✅ (section_id, name) 唯一性约束生效
- ✅ 所有验证正确
- ✅ 测试覆盖

**相关文件**:
- backend/app/models/category.py (改造)
- backend/app/schemas/category.py (改造)
- backend/app/services/category_service.py (改造)
- backend/app/routes/categories.py (改造)

---

## Task A-15.4: 后端 API - 文章管理改造

**类型**: Backend / API  
**优先级**: 🔴 高  
**依赖**: A-15.1, A-15.2, A-15.3  
**预计工时**: 2.5-3h  
**状态**: 🟡 待启动  

### 需求

改造文章 API，支持新的 section + category 维度，以及条件化的 platform_id

### 子任务

- [ ] A-15.4.1: 改造 `Article` Model 和 Schema
  - 新增: section_id (FK), category_id (FK)
  - 移除: 旧的 category (VARCHAR) 字段
  - ArticleResponse 中包含 section_name, category_name

- [ ] A-15.4.2: 改造 `ArticleService.create_article`
  - 验证 section_id, category_id 存在且关联正确
  - 如果 section.requires_platform = true，则 platform_id 必填
  - 其他情况 platform_id 可为 NULL

- [ ] A-15.4.3: 改造文章列表和过滤
  ```
  GET /api/articles?section_id=2&category_id=1  - 新过滤方式
  GET /api/articles?section_id=4                - 所有验证栏目文章
  ```

- [ ] A-15.4.4: 改造文章更新逻辑
  - 不允许修改 section_id, category_id (创建后固定)
  - 如果修改平台关联，检查 section 是否允许

- [ ] A-15.4.5: 数据迁移
  - 从旧 category (VARCHAR) 迁移到新 category_id (FK)
  - 为每篇文章赋予默认 section_id

- [ ] A-15.4.6: 编写测试
  - 创建验证栏目文章需要 platform_id
  - 创建其他栏目文章不需要 platform_id
  - 过滤和查询正常工作

**验收标准**:
- ✅ 文章可按 section + category 组合查询
- ✅ platform_id 约束生效
- ✅ 数据迁移成功
- ✅ 后向兼容性 (旧数据可用)

**相关文件**:
- backend/app/models/article.py (改造)
- backend/app/schemas/article.py (改造)
- backend/app/services/article_service.py (改造)
- backend/app/routes/articles.py (改造)

---

## Task A-15.5: 后端 API - AI 任务完整重构

**类型**: Backend / API  
**优先级**: 🔴 高  
**依赖**: A-15.1, A-15.2, A-15.3, A-15.4  
**预计工时**: 3-3.5h  
**状态**: 🟡 待启动  

### 需求

完整重构 AI 生成任务流程，添加 API 配置、请求体模板、错误处理

### 子任务

- [ ] A-15.5.1: 改造 `AIGenerationTask` Model 和 Schema
  - 新增字段: api_endpoint, api_key (加密), request_body, error_message, started_at
  - section_id, category_id (FK)
  - 改造: status ENUM, progress 整数 0-100
  - 增强 TaskResponse 包含错误信息和详细状态

- [ ] A-15.5.2: 创建 `TaskService` 业务逻辑层
  - create_generation_task: 验证section/category/platform逻辑
  - submit_task: 调用外部API，处理错误，更新progress
  - retry_task: 重试失败任务
  - get_task_details: 返回详细信息包括已生成的文章

- [ ] A-15.5.3: 创建 API 调用层 (`services/api_caller.py`)
  - 支持多种API (OpenAI, Claude, 自定义端点)
  - 模板变量替换 ({title}, {category}, 等)
  - 错误捕获和重试逻辑
  - 流式处理长响应

- [ ] A-15.5.4: 改造路由 - 新端点和改造的端点
  ```
  POST   /api/tasks/generate-articles      - 创建任务 (支持新参数)
  GET    /api/tasks                        - 列表 (支持过滤)
  GET    /api/tasks/{batch_id}             - 详情 (包含生成文章列表)
  POST   /api/tasks/{batch_id}/retry       - 重试 (*)
  DELETE /api/tasks/{batch_id}             - 删除/取消 (*)
  POST   /api/tasks/test-connection        - 测试API连接 (*)
  ```

- [ ] A-15.5.5: 错误处理和监控
  - API 调用失败时捕获并保存错误信息
  - 自动重试逻辑 (指数退避)
  - 日志记录所有操作
  - 监控 progress 更新

- [ ] A-15.5.6: 任务创建后的处理
  - 创建成功后自动异步开始处理 (Celery 或 background task)
  - 或返回 batch_id，前端轮询查询状态

- [ ] A-15.5.7: 编写测试
  - 创建有效任务
  - 创建无效任务 (缺少必填字段)
  - API 调用失败时的处理
  - 重试机制
  - 进度更新

**验收标准**:
- ✅ 支持 section + category + platform 组合
- ✅ 支持自定义 API 端点和模板
- ✅ 错误信息清晰，可供前端展示
- ✅ 任务状态实时更新
- ✅ 测试覆盖主要场景

**相关文件**:
- backend/app/models/ai_task.py (改造)
- backend/app/schemas/ai_task.py (改造)
- backend/app/services/task_service.py (新建)
- backend/app/services/api_caller.py (新建)
- backend/app/routes/tasks.py (改造)
- backend/app/tasks/celery_tasks.py (改造或新建)

---

## Task A-15.6: 前端 UI - 栏目管理页面

**类型**: Frontend / UI  
**优先级**: 🟡 中  
**依赖**: A-15.2  
**预计工时**: 1-1.5h  
**状态**: 🟡 待启动  

### 需求

创建栏目管理页面，支持增删改查

### 子任务

- [ ] A-15.6.1: 创建栏目表格
  - 显示: 名称, 别名 (slug), 是否需要平台, 状态, 操作
  - 分页、排序

- [ ] A-15.6.2: 创建"新增栏目"模态
  - 表单字段: 名称, 别名, 描述, 图标, 是否需要平台, 排序, 激活状态
  - 验证: 名称必填, 别名自动生成或手填

- [ ] A-15.6.3: 创建"编辑栏目"模态
  - 预填充现有数据

- [ ] A-15.6.4: 实现删除确认
  - 检查是否有关联分类，提示用户

- [ ] A-15.6.5: 集成 JavaScript 函数
  - loadSections(), showSectionForm(), saveSectionForm(), deleteSection()

**验收标准**:
- ✅ 可以创建、读取、更新、删除栏目
- ✅ 页面交互流畅
- ✅ 错误提示清晰

**相关文件**:
- site/admin/index.html (增加栏目管理部分)

---

## Task A-15.7: 前端 UI - 分类管理页面

**类型**: Frontend / UI  
**优先级**: 🟡 中  
**依赖**: A-15.3, A-15.6  
**预计工时**: 1.5-2h  
**状态**: 🟡 待启动  

### 需求

创建分类管理页面，支持按栏目过滤

### 子任务

- [ ] A-15.7.1: 创建栏目过滤下拉
  - 动态加载所有栏目
  - 选择时刷新分类列表

- [ ] A-15.7.2: 创建分类表格
  - 显示: 分类名, 所属栏目, 别名, 状态, 操作

- [ ] A-15.7.3: 创建"新增分类"模态
  - 自动选择当前过滤的栏目
  - 表单: 栏目 (只读), 分类名, 别名, 描述, 排序, 激活状态

- [ ] A-15.7.4: 实现编辑和删除

- [ ] A-15.7.5: 集成 JavaScript
  - loadSectionsList(), loadCategories(sectionId), saveCategoryForm(), deleteCategory()

**验收标准**:
- ✅ 分类按栏目正确过滤
- ✅ 同栏目下分类名唯一
- ✅ 可以完整进行 CRUD

**相关文件**:
- site/admin/index.html (增加分类管理部分)

---

## Task A-15.8: 前端 UI - 文章管理表单改造

**类型**: Frontend / UI  
**优先级**: 🟡 中  
**依赖**: A-15.4, A-15.7  
**预计工时**: 1.5-2h  
**状态**: 🟡 待启动  

### 需求

改造文章表单，支持栏目→分类选择，条件化显示平台字段

### 子任务

- [ ] A-15.8.1: 修改文章表单字段
  ```
  原: 分类 (VARCHAR 文本框)
  新: 栏目 (下拉选择) + 分类 (下拉选择，动态更新)
  ```

- [ ] A-15.8.2: 实现栏目选择
  - 加载所有栏目
  - 选择时更新分类下拉列表

- [ ] A-15.8.3: 实现分类选择
  - 只显示当前栏目下的分类
  - 选择时决定是否显示平台字段

- [ ] A-15.8.4: 条件化显示平台字段
  ```javascript
  if (selectedSection.requires_platform === true) {
      // 显示平台下拉，且为必填
      platformField.style.display = 'block';
      platformField.required = true;
  } else {
      // 隐藏平台字段，且为可选
      platformField.style.display = 'none';
      platformField.required = false;
  }
  ```

- [ ] A-15.8.5: 更新 saveArticleForm() 函数
  - 发送新的字段结构 (section_id, category_id)
  - 根据条件包含 platform_id

- [ ] A-15.8.6: 更新列表显示
  - 显示: 标题, 栏目, 分类, 平台 (如有), 状态, 操作

**验收标准**:
- ✅ 栏目和分类动态联动
- ✅ 平台字段条件化显示/隐藏
- ✅ 表单提交数据结构正确

**相关文件**:
- site/admin/index.html (文章表单部分)

---

## Task A-15.9: 前端 UI - AI 任务表单完整重构

**类型**: Frontend / UI  
**优先级**: 🔴 高  
**依赖**: A-15.5, A-15.8  
**预计工时**: 2-2.5h  
**状态**: 🟡 待启动  

### 需求

完整重构 AI 任务表单，支持 API 配置、错误提示、进度监控

### 子任务

- [ ] A-15.9.1: 改造第一部分 - 栏目和分类选择
  ```
  栏目: [百科 ▼]
  分类: [基础概念 ▼]
  平台: (条件化显示)
  ```

- [ ] A-15.9.2: 新增第二部分 - API 配置
  ```
  模型: [gpt-3.5-turbo ▼]
  API 端点: [https://api.openai.com/v1/...] (文本框)
  API Key: [sk-***] (密码框)
  温度参数: [0.7] (滑块)
  [测试连接] 按钮
  ```

- [ ] A-15.9.3: 新增第三部分 - 请求体模板
  ```
  请求体模板 (JSON):
  {
      "model": "gpt-3.5-turbo",
      "messages": [
          {"role": "system", "content": "你是金融写手"},
          {"role": "user", "content": "写一篇关于{title}的介绍"}
      ]
  }
  
  [预填充预设] [自定义] 两个标签
  ```

- [ ] A-15.9.4: 保持第四部分 - 批量标题输入
  ```
  批量标题 (一行一个):
  [多行文本框]
  ```

- [ ] A-15.9.5: 实现"测试连接"功能
  - 调用 POST /api/tasks/test-connection
  - 显示成功/失败提示

- [ ] A-15.9.6: 改造提交逻辑
  - 验证所有必填字段
  - 发送新的请求体结构
  - 处理返回的 batch_id

- [ ] A-15.9.7: 改造任务列表显示
  - 显示: 栏目/分类, 标题数, 状态, 进度%, 错误信息 (如有), 操作
  - 实时轮询更新进度
  - 显示已生成文章列表

- [ ] A-15.9.8: 实现任务详情页
  - 显示任务参数
  - 显示每个标题的生成状态
  - 显示错误信息
  - "重试"和"取消"按钮

**验收标准**:
- ✅ 可以配置API端点和密钥
- ✅ 支持自定义请求体模板
- ✅ 可以测试连接
- ✅ 任务进度实时更新
- ✅ 错误信息清晰可见

**相关文件**:
- site/admin/index.html (AI任务表单和列表部分)

---

## Task A-15.10: 集成测试和文档

**类型**: QA / Documentation  
**优先级**: 🟡 中  
**依赖**: 所有前置任务完成  
**预计工时**: 2-3h  
**状态**: 🟡 待启动  

### 子任务

- [ ] A-15.10.1: E2E 测试场景 1 - 百科栏目工作流
  ```
  1. 创建栏目: 百科
  2. 创建分类: 基础概念, 风险管理
  3. 创建文章: 百科 → 基础概念 (无平台)
  4. 创建AI任务: 百科 → 基础概念 (无平台字段)
  5. 验证文章成功生成
  ```

- [ ] A-15.10.2: E2E 测试场景 2 - 验证栏目工作流
  ```
  1. 创建栏目: 验证记录 (requires_platform=true)
  2. 创建分类: 曝光, 验证
  3. 创建文章: 验证 → 曝光 → Binance (必须选平台)
  4. 创建AI任务: 验证 → 曝光 → Binance (必须选平台)
  5. 验证任务进度和错误处理
  ```

- [ ] A-15.10.3: E2E 测试场景 3 - 错误处理
  ```
  1. 尝试创建文章缺少必填字段
  2. 尝试创建验证栏目文章但不选平台
  3. API 配置错误时的错误处理
  4. 网络超时时的处理
  ```

- [ ] A-15.10.4: 更新用户文档
  - 更新 ADMIN_PANEL_USER_GUIDE.md
  - 添加新的栏目、分类、AI配置操作说明
  - 添加常见问题和故障排除

- [ ] A-15.10.5: 更新开发文档
  - API 文档更新
  - 数据模型变更说明
  - 迁移指南

- [ ] A-15.10.6: 性能测试
  - 测试大量分类下的加载速度
  - 测试大批量AI任务的性能
  - 优化数据库查询

**验收标准**:
- ✅ 两个主要工作流完整可用
- ✅ 错误处理符合预期
- ✅ 文档更新完整
- ✅ 没有性能瓶颈

**相关文件**:
- ADMIN_PANEL_USER_GUIDE.md (更新)
- tests/test_sections.py (新建)
- tests/test_categories.py (新建)
- tests/test_articles_refactored.py (新建)
- tests/test_ai_tasks_refactored.py (新建)

---

## 任务依赖关系图

```
A-15.1 (数据模型)
  ├── A-15.2 (栏目 API)
  ├── A-15.3 (分类 API) ← 依赖 A-15.2
  ├── A-15.4 (文章 API) ← 依赖 A-15.2, A-15.3
  └── A-15.5 (AI任务 API) ← 依赖 A-15.2, A-15.3, A-15.4

A-15.2 → A-15.6 (栏目管理页面)
A-15.3, A-15.6 → A-15.7 (分类管理页面)
A-15.4, A-15.7 → A-15.8 (文章表单改造)
A-15.5, A-15.8 → A-15.9 (AI任务表单改造)

所有 → A-15.10 (集成测试)
```

---

## 时间线规划

**第1天 (4-5小时)**:
- ✅ A-15.1: 数据库设计和迁移 (2-3h)
- 开始 A-15.2: 栏目 API (1-2h)

**第2天 (5-6小时)**:
- 完成 A-15.2, A-15.3, A-15.4 (后端 API)
- 完成 A-15.5 (AI任务 API)

**第3天 (4-5小时)**:
- A-15.6 到 A-15.9 (前端 UI)

**第4天 (2-3小时)**:
- A-15.10 (测试和文档)

**总计**: 12-16小时，预计 1.5-2 个工作日完成

---

## 风险和缓解

| 风险 | 概率 | 影响 | 缓解 |
|------|------|------|------|
| 数据迁移失败 | 中 | 高 | 提前备份，逐步迁移，回滚测试 |
| API 兼容性问题 | 低 | 高 | 版本控制，前后端同步测试 |
| 前端集成复杂 | 中 | 中 | 模块化开发，充分测试 |
| 性能下降 | 低 | 中 | 查询优化，索引规划 |

---

## 完成标准

✅ 所有表结构创建并通过迁移  
✅ 所有 API 端点可用且返回正确响应  
✅ 前端 UI 完全改造  
✅ 两个主要工作流通过 E2E 测试  
✅ 文档更新完整  
✅ 0 个阻塞性 bug  

---

**Created**: 2025-11-08  
**Status**: 📋 Awaiting Approval  
**Owner**: AI Assistant  
