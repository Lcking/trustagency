# ä»»åŠ¡ B-1: API ç«¯ç‚¹å®¡è®¡å’Œæ–‡æ¡£

**ä»»åŠ¡ ID**: B-1  
**ä¼˜å…ˆçº§**: P0 (å…³é”®)  
**å¤æ‚åº¦**: M (ä¸­ç­‰)  
**é¢„è®¡å·¥æ—¶**: 6-8 å°æ—¶  
**è´Ÿè´£äºº**: Backend Team  
**å¼€å§‹æ—¥æœŸ**: 2025-11-12  
**å®Œæˆæ—¥æœŸ**: 2025-11-13  
**çŠ¶æ€**: â³ å¾…å¯åŠ¨

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å¯¹ç°æœ‰çš„æ‰€æœ‰åç«¯ API ç«¯ç‚¹è¿›è¡Œå®¡è®¡ï¼Œç”Ÿæˆå®Œæ•´çš„ Swagger/OpenAPI æ–‡æ¡£ï¼Œå¹¶åˆ¶å®šå‰ç«¯è°ƒç”¨è§„èŒƒã€‚è¿™æ˜¯åç»­å‰ç«¯é›†æˆçš„åŸºç¡€ã€‚

---

## ğŸ¯ ç›®æ ‡

1. âœ… å®¡è®¡æ‰€æœ‰åç«¯ API ç«¯ç‚¹
2. âœ… ç”Ÿæˆ Swagger/OpenAPI 3.0 æ–‡æ¡£
3. âœ… åˆ›å»º API ä½¿ç”¨æŒ‡å—
4. âœ… åˆ¶å®šå‰ç«¯è°ƒç”¨è§„èŒƒå’Œæœ€ä½³å®è·µ
5. âœ… æä¾›å¯æ‰§è¡Œçš„ Postman é›†åˆ

---

## ğŸ“ ä»»åŠ¡å†…å®¹

### 1. å®¡è®¡ç°æœ‰ API ç«¯ç‚¹

**Step 1.1**: æ‰«æåç«¯ä»£ç æ‰¾å‡ºæ‰€æœ‰è·¯ç”±

```bash
cd backend
grep -r "@app\|@router" app/routes/*.py app/main.py
```

**é¢„æœŸå‘ç°çš„ç«¯ç‚¹**:

#### è®¤è¯ç›¸å…³
- `POST /api/admin/login` - ç®¡ç†å‘˜ç™»å½•
- `POST /api/admin/logout` - ç™»å‡º
- `POST /api/admin/refresh-token` - åˆ·æ–°ä»¤ç‰Œ

#### æ–‡ç« ç®¡ç†
- `GET /api/articles` - è·å–æ–‡ç« åˆ—è¡¨
- `GET /api/articles/{id}` - è·å–å•ç¯‡æ–‡ç« 
- `POST /api/articles` - åˆ›å»ºæ–‡ç« 
- `PUT /api/articles/{id}` - æ›´æ–°æ–‡ç« 
- `DELETE /api/articles/{id}` - åˆ é™¤æ–‡ç« 

#### ç”¨æˆ·ç®¡ç†
- `GET /api/users` - è·å–ç”¨æˆ·åˆ—è¡¨
- `GET /api/users/{id}` - è·å–ç”¨æˆ·è¯¦æƒ…
- `POST /api/users` - åˆ›å»ºç”¨æˆ·
- `PUT /api/users/{id}` - æ›´æ–°ç”¨æˆ·
- `DELETE /api/users/{id}` - åˆ é™¤ç”¨æˆ·

#### æ ç›®ç®¡ç†
- `GET /api/sections` - è·å–æ ç›®åˆ—è¡¨
- `POST /api/sections` - åˆ›å»ºæ ç›®
- `PUT /api/sections/{id}` - æ›´æ–°æ ç›®
- `DELETE /api/sections/{id}` - åˆ é™¤æ ç›®

#### åˆ†ç±»ç®¡ç†
- `GET /api/categories` - è·å–åˆ†ç±»åˆ—è¡¨
- `GET /api/categories/section/{section_id}` - æŒ‰æ ç›®è·å–åˆ†ç±»
- `POST /api/categories` - åˆ›å»ºåˆ†ç±»
- `PUT /api/categories/{id}` - æ›´æ–°åˆ†ç±»
- `DELETE /api/categories/{id}` - åˆ é™¤åˆ†ç±»

#### AI é…ç½®
- `GET /api/ai-configs` - è·å– AI é…ç½®åˆ—è¡¨
- `POST /api/ai-configs` - åˆ›å»º AI é…ç½®
- `PUT /api/ai-configs/{id}` - æ›´æ–° AI é…ç½®
- `DELETE /api/ai-configs/{id}` - åˆ é™¤ AI é…ç½®
- `POST /api/ai-configs/{id}/test` - æµ‹è¯• AI é…ç½®

#### å¹³å°ç®¡ç†
- `GET /api/platforms` - è·å–å¹³å°åˆ—è¡¨
- `POST /api/platforms` - åˆ›å»ºå¹³å°
- `PUT /api/platforms/{id}` - æ›´æ–°å¹³å°
- `DELETE /api/platforms/{id}` - åˆ é™¤å¹³å°

#### æ–‡ä»¶ä¸Šä¼ 
- `POST /api/upload` - ä¸Šä¼ æ–‡ä»¶
- `POST /api/upload/multiple` - æ‰¹é‡ä¸Šä¼ 

#### å…¶ä»–
- `GET /api/health` - å¥åº·æ£€æŸ¥
- `GET /api/admin/stats` - è·å–ç»Ÿè®¡æ•°æ®

**Step 1.2**: ä¸ºæ¯ä¸ªç«¯ç‚¹ç¼–å†™æ–‡æ¡£

å¯¹æ¯ä¸ªç«¯ç‚¹ï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
```
ç«¯ç‚¹: GET /api/articles
æè¿°: è·å–æ–‡ç« åˆ—è¡¨ (åˆ†é¡µ)
è®¤è¯: éœ€è¦
æ–¹æ³•: GET
å‚æ•°:
  - skip: int (å¯é€‰ï¼Œé»˜è®¤ 0)
  - limit: int (å¯é€‰ï¼Œé»˜è®¤ 20)
  - search: str (å¯é€‰ï¼Œæœç´¢æ–‡æœ¬)
  - section_id: int (å¯é€‰ï¼Œæ ç›®è¿‡æ»¤)
è¯·æ±‚ä½“: æ— 
å“åº”çŠ¶æ€: 200 OK
å“åº”æ ¼å¼:
{
  "total": 100,
  "items": [
    {
      "id": 1,
      "title": "æ–‡ç« æ ‡é¢˜",
      "slug": "article-slug",
      "content": "æ–‡ç« å†…å®¹",
      "summary": "æ‘˜è¦",
      "is_published": true,
      "created_at": "2025-11-12T10:00:00",
      "updated_at": "2025-11-12T10:00:00"
    }
  ]
}
```

### 2. ç”Ÿæˆ Swagger/OpenAPI æ–‡æ¡£

**Step 2.1**: FastAPI å·²å†…ç½® Swagger æ”¯æŒ

ç¡®ä¿ FastAPI åº”ç”¨é…ç½®äº† OpenAPI:

```python
# backend/app/main.py
app = FastAPI(
    title="TrustAgency API",
    description="åå°ç®¡ç† API",
    version="1.0.0",
    docs_url="/api/docs",
    openapi_url="/api/openapi.json"
)
```

**Step 2.2**: ä¸ºæ¯ä¸ªè·¯ç”±æ·»åŠ  Swagger æ–‡æ¡£

ç¤ºä¾‹:

```python
@app.get("/api/articles", tags=["Articles"])
async def list_articles(
    skip: int = Query(0, ge=0),
    limit: int = Query(20, ge=1, le=100),
    search: Optional[str] = None,
    section_id: Optional[int] = None,
    db: Session = Depends(get_db)
):
    """
    è·å–æ–‡ç« åˆ—è¡¨ (åˆ†é¡µ)
    
    ### å‚æ•°
    - **skip**: è·³è¿‡è®°å½•æ•° (é»˜è®¤ 0)
    - **limit**: è¿”å›è®°å½•æ•° (é»˜è®¤ 20ï¼Œæœ€å¤§ 100)
    - **search**: æœç´¢æ–‡æœ¬
    - **section_id**: æ ç›® ID è¿‡æ»¤
    
    ### è¿”å›
    åˆ†é¡µæ–‡ç« åˆ—è¡¨åŠæ€»æ•°
    
    ### ç¤ºä¾‹
    ```
    GET /api/articles?skip=0&limit=20&search=python
    ```
    """
    # å®ç°é€»è¾‘...
    pass
```

**Step 2.3**: è®¿é—®å’Œå¯¼å‡ºæ–‡æ¡£

- è®¿é—® Swagger UI: `http://localhost:8001/api/docs`
- è®¿é—® ReDoc: `http://localhost:8001/api/redoc`
- å¯¼å‡º OpenAPI JSON: `http://localhost:8001/api/openapi.json`

### 3. åˆ›å»º API ä½¿ç”¨æŒ‡å—

**æ–‡ä»¶ä½ç½®**: `docs/API_GUIDE.md`

å†…å®¹åŒ…æ‹¬:

#### 3.1 æ¦‚è¿°
- åŸºç¡€ URL
- è®¤è¯æ–¹å¼
- å“åº”æ ¼å¼

#### 3.2 è®¤è¯
```markdown
### è®¤è¯æ–¹å¼: Bearer Token

æ‰€æœ‰éœ€è¦è®¤è¯çš„è¯·æ±‚éƒ½éœ€è¦åœ¨ Header ä¸­åŒ…å«:
```
Authorization: Bearer <your_access_token>
```

è·å– Token:
```
POST /api/admin/login
Content-Type: application/json

{
  "username": "admin",
  "password": "password"
}
```

å“åº”:
```
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer",
  "expires_in": 3600
}
```
```

#### 3.3 é”™è¯¯å¤„ç†
```markdown
### é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰é”™è¯¯éƒ½è¿”å›ä»¥ä¸‹æ ¼å¼:
```
{
  "detail": "é”™è¯¯æè¿°ä¿¡æ¯",
  "error_code": "ERR_CODE",
  "status_code": 400
}
```

å¸¸è§é”™è¯¯ç :
- 400 Bad Request - è¯·æ±‚å‚æ•°é”™è¯¯
- 401 Unauthorized - æœªè®¤è¯
- 403 Forbidden - ç¦æ­¢è®¿é—®
- 404 Not Found - èµ„æºä¸å­˜åœ¨
- 409 Conflict - å†²çª (å¦‚é‡å¤åˆ›å»º)
- 500 Internal Server Error - æœåŠ¡å™¨é”™è¯¯
```
```

#### 3.4 åˆ†é¡µ
```markdown
### åˆ†é¡µè§„åˆ™

åˆ—è¡¨æŸ¥è¯¢æ”¯æŒåˆ†é¡µ:
```
GET /api/articles?skip=0&limit=20
```

å“åº”æ ¼å¼:
```
{
  "total": 100,
  "items": [...],
  "skip": 0,
  "limit": 20
}
```
```
```

#### 3.5 æœç´¢å’Œè¿‡æ»¤
```markdown
### æœç´¢

æ”¯æŒå…¨æ–‡æœç´¢:
```
GET /api/articles?search=å…³é”®è¯
```

### è¿‡æ»¤

æ”¯æŒæŒ‰å­—æ®µè¿‡æ»¤:
```
GET /api/articles?section_id=1&is_published=true
```
```
```

### 4. åˆ¶å®šå‰ç«¯è°ƒç”¨è§„èŒƒ

**æ–‡ä»¶ä½ç½®**: `docs/FRONTEND_API_SPEC.md`

å†…å®¹:

#### 4.1 å‰ç«¯ API å®¢æˆ·ç«¯æ¶æ„

```javascript
// frontend/api.js
class APIClient {
  constructor(baseURL) {
    this.baseURL = baseURL;
    this.token = null;
  }

  setToken(token) {
    this.token = token;
  }

  async request(method, endpoint, data = null) {
    // å®ç°ç»†èŠ‚...
  }

  // æŒ‰ä¸šåŠ¡åˆ†ç±»
  articles = { list(), get(), create(), update(), delete() }
  users = { list(), get(), create(), update(), delete() }
  categories = { list(), create(), update(), delete() }
  // ...
}
```

#### 4.2 è°ƒç”¨çº¦å®š

```markdown
1. **æ‰€æœ‰è¯·æ±‚éƒ½åº”è¯¥å¤„ç†é”™è¯¯**
   ```javascript
   try {
     const data = await api.articles.list();
   } catch (error) {
     console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
     showErrorToast(error.message);
   }
   ```

2. **é•¿æ“ä½œåº”æ˜¾ç¤ºåŠ è½½çŠ¶æ€**
   ```javascript
   const handleSubmit = async () => {
     setLoading(true);
     try {
       await api.articles.create(formData);
       showSuccessToast('åˆ›å»ºæˆåŠŸ');
     } catch (error) {
       showErrorToast(error.message);
     } finally {
       setLoading(false);
     }
   }
   ```

3. **æ•æ„Ÿæ“ä½œéœ€è¦ç¡®è®¤**
   ```javascript
   const handleDelete = async (id) => {
     if (!confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) return;
     try {
       await api.articles.delete(id);
       showSuccessToast('åˆ é™¤æˆåŠŸ');
     } catch (error) {
       showErrorToast(error.message);
     }
   }
   ```

4. **ä½¿ç”¨åˆç†çš„ç¼“å­˜ç­–ç•¥**
   ```javascript
   // ç”¨æˆ·åˆ—è¡¨å¯ä»¥ç¼“å­˜ï¼Œå› ä¸ºä¸å¸¸å˜
   let usersCache = null;
   async function getUsers() {
     if (usersCache) return usersCache;
     usersCache = await api.users.list();
     return usersCache;
   }
   ```
```

### 5. åˆ›å»º Postman é›†åˆ

**æ–‡ä»¶ä½ç½®**: `docs/TrustAgency_API.postman_collection.json`

å¯¼å‡º Postman é›†åˆçš„æ­¥éª¤:
1. è®¿é—® `http://localhost:8001/api/openapi.json`
2. åœ¨ Postman ä¸­å¯¼å…¥ OpenAPI
3. æ·»åŠ ç¯å¢ƒå˜é‡:
   - `base_url`: `http://localhost:8001`
   - `token`: (ç™»å½•åè‡ªåŠ¨è®¾ç½®)
4. æ·»åŠ å‰ç½®è„šæœ¬è‡ªåŠ¨æ›´æ–° token
5. å¯¼å‡ºä¸ºé›†åˆæ–‡ä»¶

---

## âœ… éªŒæ”¶æ ‡å‡†

### æ–‡æ¡£å®Œæ•´æ€§
- [ ] Swagger UI å¯è®¿é—® (`/api/docs`)
- [ ] ReDoc å¯è®¿é—® (`/api/redoc`)
- [ ] OpenAPI JSON å¯å¯¼å‡º (`/api/openapi.json`)
- [ ] æ‰€æœ‰ç«¯ç‚¹éƒ½æœ‰æè¿°
- [ ] æ‰€æœ‰å‚æ•°éƒ½æœ‰è¯´æ˜
- [ ] æ‰€æœ‰å“åº”éƒ½æœ‰ç¤ºä¾‹

### æŒ‡å—å®Œæ•´æ€§
- [ ] API ä½¿ç”¨æŒ‡å—å®Œæˆ
- [ ] å‰ç«¯è°ƒç”¨è§„èŒƒæ–‡æ¡£å®Œæˆ
- [ ] Postman é›†åˆå¯ç”¨
- [ ] åŒ…å« 5+ ä¸ªå®é™…ç¤ºä¾‹
- [ ] åŒ…å«å¸¸è§é”™è¯¯æ’æŸ¥

### ä»£ç è´¨é‡
- [ ] æ²¡æœ‰æ‹¼å†™é”™è¯¯
- [ ] ä»£ç ç¤ºä¾‹éƒ½èƒ½è¿è¡Œ
- [ ] æ–‡æ¡£æ ¼å¼ä¸€è‡´
- [ ] é“¾æ¥éƒ½æœ‰æ•ˆ

---

## ğŸ“‚ æ–‡ä»¶æ¸…å•

éœ€è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶:

```
docs/
  â”œâ”€â”€ API_GUIDE.md (æ–°å»º)
  â”œâ”€â”€ FRONTEND_API_SPEC.md (æ–°å»º)
  â”œâ”€â”€ ERROR_CODES.md (æ–°å»º)
  â””â”€â”€ TrustAgency_API.postman_collection.json (æ–°å»º)

backend/
  â”œâ”€â”€ app/
  â”‚   â”œâ”€â”€ main.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚   â””â”€â”€ routes/
  â”‚       â”œâ”€â”€ articles.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚       â”œâ”€â”€ users.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚       â”œâ”€â”€ categories.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚       â”œâ”€â”€ sections.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚       â”œâ”€â”€ auth.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚       â”œâ”€â”€ upload.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚       â”œâ”€â”€ ai_configs.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚       â”œâ”€â”€ platforms.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â”‚       â””â”€â”€ tasks.py (ä¿®æ”¹ - æ·»åŠ æ–‡æ¡£)
  â””â”€â”€ ...
```

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Day 1 (å‘¨ä¸€) - ä¸Šåˆ

1. **9:00-10:00**: ä»£ç å®¡æŸ¥
   - æ£€æŸ¥ç°æœ‰ API å®ç°
   - è¯†åˆ«ç¼ºå¤±çš„æ–‡æ¡£

2. **10:00-11:00**: æ›´æ–° FastAPI é…ç½®
   - ç¡®ä¿ Swagger å¯ç”¨
   - æµ‹è¯•æ–‡æ¡£è®¿é—®

3. **11:00-12:00**: ä¸º API æ·»åŠ æ–‡æ¡£
   - è¡¥å…… docstring
   - æ·»åŠ å‚æ•°è¯´æ˜

### Day 1 (å‘¨ä¸€) - ä¸‹åˆ

4. **13:00-14:00**: åˆ›å»ºä½¿ç”¨æŒ‡å—
   - ç¼–å†™è®¤è¯è¯´æ˜
   - ç¼–å†™é”™è¯¯å¤„ç†

5. **14:00-15:00**: åˆ›å»ºè§„èŒƒæ–‡æ¡£
   - å‰ç«¯è°ƒç”¨è§„èŒƒ
   - æœ€ä½³å®è·µ

6. **15:00-16:00**: å¯¼å‡º Postman é›†åˆ
   - ç”Ÿæˆ JSON å¯¼å‡º
   - æ·»åŠ ç¯å¢ƒå˜é‡

### Day 2 (å‘¨äºŒ) - ä¸Šåˆ

7. **9:00-10:00**: æ–‡æ¡£å®¡æŸ¥å’Œä¼˜åŒ–
8. **10:00-11:00**: åˆ›å»ºç¤ºä¾‹ä»£ç 
9. **11:00-12:00**: æœ€ç»ˆæ£€æŸ¥å’Œå‘å¸ƒ

---

## ğŸ“Š è´¨é‡æ£€æŸ¥æ¸…å•

åœ¨å®Œæˆå‰æ£€æŸ¥:

- [ ] æ‰€æœ‰ç«¯ç‚¹éƒ½å¯ä»¥è®¿é—®
- [ ] Swagger æ–‡æ¡£æ­£ç¡®æ˜¾ç¤º
- [ ] æ²¡æœ‰ 404 é”™è¯¯
- [ ] ä»£ç ç¤ºä¾‹éƒ½èƒ½æ‰§è¡Œ
- [ ] æ–‡æ¡£é“¾æ¥éƒ½æœ‰æ•ˆ
- [ ] æ²¡æœ‰æ‹¼å†™é”™è¯¯
- [ ] æ ¼å¼é£æ ¼ä¸€è‡´
- [ ] å‰ç«¯å›¢é˜Ÿå¯ä»¥ç†è§£

---

## ğŸ¯ å®Œæˆåçš„é¢„æœŸæˆæœ

1. âœ… å®Œæ•´çš„ Swagger UI
   - æ‰€æœ‰ç«¯ç‚¹å¯è§
   - å¯ä»¥ç›´æ¥æµ‹è¯• API
   - æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ

2. âœ… è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—
   - æ–°å¼€å‘è€…å¯ä»¥å¿«é€Ÿä¸Šæ‰‹
   - å‡å°‘æ²Ÿé€šæˆæœ¬
   - å‡å°‘ç†è§£åå·®

3. âœ… å‰ç«¯è°ƒç”¨è§„èŒƒ
   - ç»Ÿä¸€çš„ä»£ç é£æ ¼
   - æ¸…æ™°çš„è°ƒç”¨çº¦å®š
   - æœ€ä½³å®è·µæŒ‡å¯¼

4. âœ… å¯æ‰§è¡Œçš„ Postman é›†åˆ
   - å¯ä»¥ç›´æ¥æµ‹è¯•æ‰€æœ‰ API
   - å¯ä»¥ä¸ä»–äººå…±äº«
   - ä¾¿äº API æ¼”ç¤º

---

## ğŸ“ æ¥ä¸‹æ¥

å®Œæˆæœ¬ä»»åŠ¡å:
1. å‰ç«¯å›¢é˜Ÿå¯ä»¥å¼€å§‹ B-4 (åˆ›å»º API è°ƒç”¨åº“)
2. åç«¯å›¢é˜Ÿå¯ä»¥å¼€å§‹ B-2 (é”™è¯¯å¤„ç†æ ‡å‡†åŒ–)
3. å…¨ä½“å¯ä»¥è¿›è¡Œ API å®¡æŸ¥ä¼šè®®

---

**ä»»åŠ¡ç¼–å·**: B-1  
**ä¼˜å…ˆçº§**: P0  
**çŠ¶æ€**: â³ å¾…å¯åŠ¨  
**é¢„è®¡å®Œæˆ**: 2025-11-13  
**æœ€åæ›´æ–°**: 2025-11-12
