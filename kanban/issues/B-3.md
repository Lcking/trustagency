# ä»»åŠ¡ B-3: æ•°æ®éªŒè¯å’Œä¸šåŠ¡è§„åˆ™

**ä»»åŠ¡ ID**: B-3  
**ä¼˜å…ˆçº§**: P0 (å…³é”®)  
**å¤æ‚åº¦**: M (ä¸­ç­‰)  
**é¢„è®¡å·¥æ—¶**: 5-7 å°æ—¶  
**è´Ÿè´£äºº**: Backend Team  
**å¼€å§‹æ—¥æœŸ**: 2025-11-13  
**å®Œæˆæ—¥æœŸ**: 2025-11-14  
**çŠ¶æ€**: â³ å¾…å¯åŠ¨  
**ä¾èµ–**: B-1 (API å®¡è®¡)ã€B-2 (é”™è¯¯å¤„ç†)

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å»ºç«‹ç»Ÿä¸€çš„æ•°æ®éªŒè¯æ¡†æ¶å’Œä¸šåŠ¡è§„åˆ™å¼•æ“ï¼Œç¡®ä¿æ‰€æœ‰è¾“å…¥æ•°æ®çš„æœ‰æ•ˆæ€§ï¼Œé˜²æ­¢æ— æ•ˆæ•°æ®è¿›å…¥ç³»ç»Ÿï¼Œæå‡æ•°æ®è´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

---

## ğŸ¯ ç›®æ ‡

1. âœ… å®šä¹‰æ‰€æœ‰æ•°æ®æ¨¡å‹çš„éªŒè¯è§„åˆ™
2. âœ… å®ç°ç»Ÿä¸€çš„éªŒè¯æ¡†æ¶
3. âœ… å»ºç«‹ä¸šåŠ¡è§„åˆ™å¼•æ“
4. âœ… åˆ›å»ºéªŒè¯å·¥å…·åº“
5. âœ… ç¼–å†™éªŒè¯æµ‹è¯•ç”¨ä¾‹

---

## ğŸ“ ä»»åŠ¡å†…å®¹

### 1. å®šä¹‰ Pydantic æ•°æ®éªŒè¯æ¨¡å‹

**æ–‡ä»¶ä½ç½®**: `backend/app/schemas/articles.py` (æ–°å»º/ä¿®æ”¹)

```python
from pydantic import BaseModel, Field, validator, HttpUrl
from typing import Optional, List
from datetime import datetime
import re


class ArticleBase(BaseModel):
    """æ–‡ç« åŸºç¡€æ¨¡å‹"""
    
    title: str = Field(
        ...,
        min_length=3,
        max_length=200,
        description="æ–‡ç« æ ‡é¢˜ï¼Œ3-200 ä¸ªå­—ç¬¦"
    )
    
    slug: str = Field(
        ...,
        min_length=3,
        max_length=100,
        regex="^[a-z0-9-]+$",
        description="URL å‹å¥½çš„æ ‡é¢˜ï¼Œåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦"
    )
    
    content: str = Field(
        ...,
        min_length=10,
        description="æ–‡ç« å†…å®¹ï¼Œè‡³å°‘ 10 ä¸ªå­—ç¬¦"
    )
    
    summary: Optional[str] = Field(
        None,
        max_length=500,
        description="æ–‡ç« æ‘˜è¦ï¼Œæœ€å¤š 500 ä¸ªå­—ç¬¦"
    )
    
    section_id: int = Field(
        ...,
        gt=0,
        description="æ ç›® IDï¼Œå¿…é¡»æ˜¯æ­£æ•´æ•°"
    )
    
    category_id: Optional[int] = Field(
        None,
        gt=0,
        description="åˆ†ç±» ID"
    )
    
    featured_image: Optional[HttpUrl] = Field(
        None,
        description="æ–‡ç« ä¸»å›¾ URL"
    )
    
    is_published: bool = Field(
        False,
        description="æ˜¯å¦å‘å¸ƒ"
    )
    
    published_at: Optional[datetime] = Field(
        None,
        description="å‘å¸ƒæ—¶é—´"
    )
    
    tags: List[str] = Field(
        default_factory=list,
        max_items=10,
        description="æ ‡ç­¾åˆ—è¡¨ï¼Œæœ€å¤š 10 ä¸ª"
    )
    
    @validator('title')
    def title_not_empty(cls, v):
        """æ ‡é¢˜ä¸èƒ½åªåŒ…å«ç©ºæ ¼"""
        if not v.strip():
            raise ValueError('æ ‡é¢˜ä¸èƒ½ä¸ºç©º')
        return v.strip()
    
    @validator('slug')
    def slug_unique_format(cls, v):
        """slug æ ¼å¼éªŒè¯"""
        if not re.match(r'^[a-z0-9]+(?:-[a-z0-9]+)*$', v):
            raise ValueError('slug åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦')
        return v.lower()
    
    @validator('content')
    def content_not_html(cls, v):
        """å†…å®¹ä¸èƒ½åªæ˜¯ HTML"""
        # ç§»é™¤ HTML æ ‡ç­¾åæ£€æŸ¥æ˜¯å¦æœ‰å®é™…å†…å®¹
        import re
        text = re.sub(r'<[^>]+>', '', v)
        if len(text.strip()) < 10:
            raise ValueError('æ–‡ç« å†…å®¹è¿‡å°‘ï¼Œè‡³å°‘éœ€è¦ 10 ä¸ªå­—ç¬¦')
        return v
    
    @validator('tags', pre=True)
    def validate_tags(cls, v):
        """æ ‡ç­¾éªŒè¯"""
        if not isinstance(v, list):
            raise ValueError('æ ‡ç­¾å¿…é¡»æ˜¯åˆ—è¡¨')
        
        # è¿‡æ»¤ç©ºæ ‡ç­¾
        tags = [tag.strip() for tag in v if isinstance(tag, str) and tag.strip()]
        
        # æ£€æŸ¥é‡å¤
        if len(tags) != len(set(tags)):
            raise ValueError('æ ‡ç­¾ä¸èƒ½é‡å¤')
        
        # æ£€æŸ¥æ ‡ç­¾é•¿åº¦
        for tag in tags:
            if len(tag) > 50:
                raise ValueError(f'æ ‡ç­¾è¿‡é•¿ï¼š{tag}')
        
        return tags
    
    @validator('is_published')
    def validate_publication_state(cls, v, values):
        """å‘å¸ƒçŠ¶æ€éªŒè¯"""
        if v and not values.get('published_at'):
            raise ValueError('å‘å¸ƒæ–‡ç« å¿…é¡»è®¾ç½®å‘å¸ƒæ—¶é—´')
        return v
    
    class Config:
        schema_extra = {
            "example": {
                "title": "æ·±åº¦å­¦ä¹ å…¥é—¨æŒ‡å—",
                "slug": "deep-learning-guide",
                "content": "<p>æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯...</p>",
                "summary": "è¿™æ˜¯ä¸€ç¯‡å…³äºæ·±åº¦å­¦ä¹ å…¥é—¨çš„æ–‡ç« ",
                "section_id": 1,
                "category_id": 5,
                "is_published": True,
                "tags": ["æ·±åº¦å­¦ä¹ ", "æœºå™¨å­¦ä¹ ", "AI"]
            }
        }


class ArticleCreate(ArticleBase):
    """åˆ›å»ºæ–‡ç« æ—¶çš„éªŒè¯æ¨¡å‹"""
    pass


class ArticleUpdate(BaseModel):
    """æ›´æ–°æ–‡ç« æ—¶çš„éªŒè¯æ¨¡å‹ (æ‰€æœ‰å­—æ®µå¯é€‰)"""
    
    title: Optional[str] = Field(None, min_length=3, max_length=200)
    slug: Optional[str] = Field(None, min_length=3, max_length=100)
    content: Optional[str] = Field(None, min_length=10)
    summary: Optional[str] = Field(None, max_length=500)
    section_id: Optional[int] = Field(None, gt=0)
    category_id: Optional[int] = Field(None, gt=0)
    featured_image: Optional[HttpUrl] = None
    is_published: Optional[bool] = None
    published_at: Optional[datetime] = None
    tags: Optional[List[str]] = Field(None, max_items=10)


class ArticleResponse(ArticleBase):
    """æ–‡ç« å“åº”æ¨¡å‹"""
    
    id: int
    created_at: datetime
    updated_at: datetime
    author_id: int
    view_count: int = 0
    
    class Config:
        from_attributes = True
```

### 2. åˆ›å»ºéªŒè¯å·¥å…·åº“

**æ–‡ä»¶ä½ç½®**: `backend/app/validators/validators.py` (æ–°å»º)

```python
from typing import Any, Callable, List, Optional, Pattern
import re
from datetime import datetime
from email_validator import validate_email, EmailNotValidError

from app.middleware.error_handler import APIException
from app.schemas.error import ErrorCode


class Validator:
    """éªŒè¯å·¥å…·ç±»"""
    
    @staticmethod
    def validate_email(email: str) -> str:
        """éªŒè¯é‚®ç®±æ ¼å¼"""
        try:
            valid = validate_email(email)
            return valid.email
        except EmailNotValidError as e:
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message=f"é‚®ç®±æ ¼å¼æ— æ•ˆï¼š{str(e)}"
            )
    
    @staticmethod
    def validate_password(password: str, min_length: int = 8) -> bool:
        """
        éªŒè¯å¯†ç å¼ºåº¦
        
        è¦æ±‚ï¼š
        - è‡³å°‘ 8 ä¸ªå­—ç¬¦
        - åŒ…å«å¤§å†™å­—æ¯
        - åŒ…å«å°å†™å­—æ¯
        - åŒ…å«æ•°å­—
        - åŒ…å«ç‰¹æ®Šå­—ç¬¦
        """
        if len(password) < min_length:
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message=f"å¯†ç é•¿åº¦è‡³å°‘ {min_length} ä¸ªå­—ç¬¦"
            )
        
        has_upper = re.search(r'[A-Z]', password)
        has_lower = re.search(r'[a-z]', password)
        has_digit = re.search(r'\d', password)
        has_special = re.search(r'[!@#$%^&*(),.?":{}|<>]', password)
        
        if not (has_upper and has_lower and has_digit and has_special):
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message="å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦"
            )
        
        return True
    
    @staticmethod
    def validate_username(username: str) -> str:
        """
        éªŒè¯ç”¨æˆ·å
        - 3-20 ä¸ªå­—ç¬¦
        - åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿
        - å¿…é¡»ä»¥å­—æ¯å¼€å¤´
        """
        if not re.match(r'^[a-zA-Z][a-zA-Z0-9_]{2,19}$', username):
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message="ç”¨æˆ·åå¿…é¡» 3-20 ä¸ªå­—ç¬¦ï¼Œä»¥å­—æ¯å¼€å¤´ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿"
            )
        return username
    
    @staticmethod
    def validate_url(url: str) -> str:
        """éªŒè¯ URL æ ¼å¼"""
        url_pattern = re.compile(
            r'^https?://'  # http:// or https://
            r'(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+[A-Z]{2,6}\.?|'  # domain
            r'localhost|'  # localhost
            r'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})'  # or IP
            r'(?::\d+)?'  # optional port
            r'(?:/?|[/?]\S+)$', re.IGNORECASE
        )
        
        if not url_pattern.match(url):
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message="URL æ ¼å¼æ— æ•ˆ"
            )
        return url
    
    @staticmethod
    def validate_slug(slug: str) -> str:
        """éªŒè¯ slug æ ¼å¼"""
        if not re.match(r'^[a-z0-9]+(?:-[a-z0-9]+)*$', slug):
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message="slug åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦"
            )
        return slug
    
    @staticmethod
    def validate_phone(phone: str) -> str:
        """éªŒè¯ç”µè¯å·ç  (ä¸­å›½)"""
        if not re.match(r'^1[3-9]\d{9}$', phone):
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message="ç”µè¯å·ç æ ¼å¼æ— æ•ˆ"
            )
        return phone
    
    @staticmethod
    def validate_id_card(id_card: str) -> str:
        """éªŒè¯èº«ä»½è¯å· (ä¸­å›½)"""
        if not re.match(r'^\d{18}$|^\d{17}[\dXx]$', id_card):
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message="èº«ä»½è¯å·æ ¼å¼æ— æ•ˆ"
            )
        return id_card
    
    @staticmethod
    def validate_date_range(
        start_date: datetime,
        end_date: datetime,
        min_days: int = 0,
        max_days: int = None
    ) -> None:
        """éªŒè¯æ—¥æœŸèŒƒå›´"""
        if start_date > end_date:
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message="å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ"
            )
        
        days = (end_date - start_date).days
        
        if days < min_days:
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message=f"æ—¥æœŸèŒƒå›´è‡³å°‘éœ€è¦ {min_days} å¤©"
            )
        
        if max_days and days > max_days:
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message=f"æ—¥æœŸèŒƒå›´æœ€å¤š {max_days} å¤©"
            )
    
    @staticmethod
    def validate_file_size(size_bytes: int, max_mb: int = 10) -> None:
        """éªŒè¯æ–‡ä»¶å¤§å°"""
        max_bytes = max_mb * 1024 * 1024
        if size_bytes > max_bytes:
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message=f"æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§ {max_mb}MB"
            )
    
    @staticmethod
    def validate_file_type(filename: str, allowed_types: List[str]) -> None:
        """éªŒè¯æ–‡ä»¶ç±»å‹"""
        ext = filename.split('.')[-1].lower()
        if ext not in allowed_types:
            raise APIException(
                error_code=ErrorCode.INVALID_FORMAT,
                message=f"ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼š{ext}ï¼Œå…è®¸çš„ç±»å‹ï¼š{', '.join(allowed_types)}"
            )
    
    @staticmethod
    def validate_not_empty(value: Any, field_name: str) -> Any:
        """éªŒè¯ä¸ä¸ºç©º"""
        if value is None or (isinstance(value, str) and not value.strip()):
            raise APIException(
                error_code=ErrorCode.MISSING_PARAMETER,
                message=f"å¿…éœ€å‚æ•° {field_name} ä¸èƒ½ä¸ºç©º"
            )
        return value
    
    @staticmethod
    def validate_in_list(value: Any, allowed_values: List[Any], field_name: str) -> Any:
        """éªŒè¯å€¼åœ¨å…è®¸çš„åˆ—è¡¨ä¸­"""
        if value not in allowed_values:
            raise APIException(
                error_code=ErrorCode.INVALID_PARAMETER,
                message=f"{field_name} å¿…é¡»æ˜¯ä»¥ä¸‹å€¼ä¹‹ä¸€ï¼š{', '.join(str(v) for v in allowed_values)}"
            )
        return value
```

### 3. åˆ›å»ºä¸šåŠ¡è§„åˆ™éªŒè¯å™¨

**æ–‡ä»¶ä½ç½®**: `backend/app/validators/business_rules.py` (æ–°å»º)

```python
from datetime import datetime
from sqlalchemy.orm import Session

from app.middleware.error_handler import APIException
from app.schemas.error import ErrorCode


class ArticleBusinessRules:
    """æ–‡ç« ä¸šåŠ¡è§„åˆ™"""
    
    @staticmethod
    def validate_article_creation(data: dict, db: Session) -> None:
        """éªŒè¯æ–‡ç« åˆ›å»ºè§„åˆ™"""
        
        # æ£€æŸ¥ slug æ˜¯å¦å”¯ä¸€
        from app.models import Article
        existing = db.query(Article).filter(Article.slug == data['slug']).first()
        if existing:
            raise APIException(
                error_code=ErrorCode.DUPLICATE_ENTRY,
                message=f"æ–‡ç«  slug '{data['slug']}' å·²å­˜åœ¨"
            )
        
        # æ£€æŸ¥æ ç›®æ˜¯å¦å­˜åœ¨
        from app.models import Section
        section = db.query(Section).filter(Section.id == data['section_id']).first()
        if not section:
            raise APIException(
                error_code=ErrorCode.RESOURCE_NOT_FOUND,
                message=f"æ ç›® (ID: {data['section_id']}) ä¸å­˜åœ¨"
            )
        
        # æ£€æŸ¥åˆ†ç±»æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚æœæŒ‡å®šäº†ï¼‰
        if data.get('category_id'):
            from app.models import Category
            category = db.query(Category).filter(Category.id == data['category_id']).first()
            if not category:
                raise APIException(
                    error_code=ErrorCode.RESOURCE_NOT_FOUND,
                    message=f"åˆ†ç±» (ID: {data['category_id']}) ä¸å­˜åœ¨"
                )
    
    @staticmethod
    def validate_article_publication(article, db: Session) -> None:
        """éªŒè¯æ–‡ç« å‘å¸ƒè§„åˆ™"""
        
        # æ£€æŸ¥æ–‡ç« æ˜¯å¦å·²å‘å¸ƒ
        if article.is_published:
            raise APIException(
                error_code=ErrorCode.OPERATION_NOT_ALLOWED,
                message="å·²å‘å¸ƒçš„æ–‡ç« ä¸èƒ½å†å‘å¸ƒ"
            )
        
        # æ£€æŸ¥å¿…éœ€å­—æ®µ
        required_fields = ['title', 'slug', 'content', 'section_id']
        missing_fields = [f for f in required_fields if not getattr(article, f)]
        if missing_fields:
            raise APIException(
                error_code=ErrorCode.INVALID_STATE,
                message=f"æ–‡ç« ç¼ºå°‘å¿…éœ€å­—æ®µï¼š{', '.join(missing_fields)}"
            )
    
    @staticmethod
    def validate_article_deletion(article, db: Session) -> None:
        """éªŒè¯æ–‡ç« åˆ é™¤è§„åˆ™"""
        
        # å·²å‘å¸ƒçš„æ–‡ç« ä¸èƒ½ç«‹å³åˆ é™¤ï¼Œåªèƒ½ä¸‹æ¶
        if article.is_published:
            raise APIException(
                error_code=ErrorCode.OPERATION_NOT_ALLOWED,
                message="å·²å‘å¸ƒçš„æ–‡ç« åº”å…ˆä¸‹æ¶å†åˆ é™¤"
            )


class UserBusinessRules:
    """ç”¨æˆ·ä¸šåŠ¡è§„åˆ™"""
    
    @staticmethod
    def validate_user_creation(data: dict, db: Session) -> None:
        """éªŒè¯ç”¨æˆ·åˆ›å»ºè§„åˆ™"""
        
        # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å”¯ä¸€
        from app.models import User
        existing = db.query(User).filter(User.username == data['username']).first()
        if existing:
            raise APIException(
                error_code=ErrorCode.DUPLICATE_ENTRY,
                message=f"ç”¨æˆ·å '{data['username']}' å·²å­˜åœ¨"
            )
        
        # æ£€æŸ¥é‚®ç®±æ˜¯å¦å”¯ä¸€
        existing = db.query(User).filter(User.email == data['email']).first()
        if existing:
            raise APIException(
                error_code=ErrorCode.DUPLICATE_ENTRY,
                message=f"é‚®ç®± '{data['email']}' å·²æ³¨å†Œ"
            )
    
    @staticmethod
    def validate_user_deletion(user, db: Session) -> None:
        """éªŒè¯ç”¨æˆ·åˆ é™¤è§„åˆ™"""
        
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å…³è”çš„æ–‡ç« 
        from app.models import Article
        articles_count = db.query(Article).filter(Article.author_id == user.id).count()
        if articles_count > 0:
            raise APIException(
                error_code=ErrorCode.OPERATION_NOT_ALLOWED,
                message=f"ç”¨æˆ·æœ‰ {articles_count} ç¯‡æ–‡ç« ï¼Œè¯·å…ˆåˆ é™¤æˆ–è½¬ç§»æ–‡ç« "
            )


class CategoryBusinessRules:
    """åˆ†ç±»ä¸šåŠ¡è§„åˆ™"""
    
    @staticmethod
    def validate_category_deletion(category, db: Session) -> None:
        """éªŒè¯åˆ†ç±»åˆ é™¤è§„åˆ™"""
        
        # æ£€æŸ¥åˆ†ç±»ä¸‹æ˜¯å¦æœ‰æ–‡ç« 
        from app.models import Article
        articles_count = db.query(Article).filter(Article.category_id == category.id).count()
        if articles_count > 0:
            raise APIException(
                error_code=ErrorCode.OPERATION_NOT_ALLOWED,
                message=f"åˆ†ç±»ä¸‹è¿˜æœ‰ {articles_count} ç¯‡æ–‡ç« ï¼Œä¸èƒ½åˆ é™¤"
            )
```

### 4. åœ¨è·¯ç”±ä¸­é›†æˆéªŒè¯

**ç¤ºä¾‹**: `backend/app/routes/articles.py` (ä¿®æ”¹)

```python
from fastapi import APIRouter, Depends, status, Body
from sqlalchemy.orm import Session

from app.schemas.articles import ArticleCreate, ArticleUpdate, ArticleResponse
from app.schemas.error import ErrorCode
from app.middleware.error_handler import APIException
from app.validators.business_rules import ArticleBusinessRules
from app.database import get_db
from app.models import Article


router = APIRouter(prefix="/api/articles", tags=["Articles"])


@router.post("", status_code=status.HTTP_201_CREATED, response_model=ArticleResponse)
async def create_article(
    article_data: ArticleCreate = Body(...),
    db: Session = Depends(get_db)
):
    """
    åˆ›å»ºæ–°æ–‡ç« 
    
    ### ä¸šåŠ¡è§„åˆ™
    - slug å¿…é¡»å”¯ä¸€
    - section_id å¿…é¡»å­˜åœ¨
    - category_id å¿…é¡»å­˜åœ¨ï¼ˆå¦‚æœæŒ‡å®šï¼‰
    """
    
    # ä¸šåŠ¡è§„åˆ™éªŒè¯ (Pydantic å·²å®Œæˆæ•°æ®éªŒè¯)
    ArticleBusinessRules.validate_article_creation(article_data.dict(), db)
    
    # åˆ›å»ºæ–‡ç« 
    article = Article(**article_data.dict())
    db.add(article)
    db.commit()
    db.refresh(article)
    
    return article


@router.put("/{article_id}", response_model=ArticleResponse)
async def update_article(
    article_id: int,
    article_data: ArticleUpdate = Body(...),
    db: Session = Depends(get_db)
):
    """
    æ›´æ–°æ–‡ç« 
    
    ### éªŒè¯è§„åˆ™
    - åªèƒ½æ›´æ–°éå‘å¸ƒçŠ¶æ€çš„æ–‡ç« 
    - æ›´æ–°åçš„ slug å¿…é¡»å”¯ä¸€
    """
    
    # æŸ¥æ‰¾æ–‡ç« 
    article = db.query(Article).filter(Article.id == article_id).first()
    if not article:
        raise APIException(
            error_code=ErrorCode.RESOURCE_NOT_FOUND,
            message=f"æ–‡ç«  (ID: {article_id}) ä¸å­˜åœ¨"
        )
    
    # å·²å‘å¸ƒæ–‡ç« åªèƒ½æ›´æ–°éƒ¨åˆ†å­—æ®µ
    if article.is_published:
        allowed_fields = {'title', 'summary', 'tags'}
        provided_fields = set(article_data.dict(exclude_unset=True).keys())
        invalid_fields = provided_fields - allowed_fields
        if invalid_fields:
            raise APIException(
                error_code=ErrorCode.OPERATION_NOT_ALLOWED,
                message=f"å·²å‘å¸ƒæ–‡ç« ä¸èƒ½æ›´æ–°ï¼š{', '.join(invalid_fields)}"
            )
    
    # æ›´æ–°æ–‡ç« 
    update_data = article_data.dict(exclude_unset=True)
    for field, value in update_data.items():
        setattr(article, field, value)
    
    db.commit()
    db.refresh(article)
    
    return article


@router.delete("/{article_id}")
async def delete_article(
    article_id: int,
    db: Session = Depends(get_db)
):
    """
    åˆ é™¤æ–‡ç« 
    
    ### ä¸šåŠ¡è§„åˆ™
    - å·²å‘å¸ƒæ–‡ç« ä¸èƒ½ç›´æ¥åˆ é™¤
    """
    
    article = db.query(Article).filter(Article.id == article_id).first()
    if not article:
        raise APIException(
            error_code=ErrorCode.RESOURCE_NOT_FOUND,
            message=f"æ–‡ç«  (ID: {article_id}) ä¸å­˜åœ¨"
        )
    
    # éªŒè¯åˆ é™¤è§„åˆ™
    ArticleBusinessRules.validate_article_deletion(article, db)
    
    db.delete(article)
    db.commit()
    
    return {"success": True, "message": "æ–‡ç« å·²åˆ é™¤"}
```

### 5. åˆ›å»ºéªŒè¯æµ‹è¯•æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**: `backend/tests/test_validators.py` (æ–°å»º)

```python
import pytest
from datetime import datetime, timedelta

from app.validators.validators import Validator
from app.middleware.error_handler import APIException


class TestEmailValidator:
    """é‚®ç®±éªŒè¯æµ‹è¯•"""
    
    def test_valid_email(self):
        """æµ‹è¯•æœ‰æ•ˆé‚®ç®±"""
        result = Validator.validate_email("user@example.com")
        assert result == "user@example.com"
    
    def test_invalid_email(self):
        """æµ‹è¯•æ— æ•ˆé‚®ç®±"""
        with pytest.raises(APIException):
            Validator.validate_email("invalid-email")
    
    def test_email_with_spaces(self):
        """æµ‹è¯•å¸¦ç©ºæ ¼çš„é‚®ç®±"""
        with pytest.raises(APIException):
            Validator.validate_email(" user@example.com ")


class TestPasswordValidator:
    """å¯†ç éªŒè¯æµ‹è¯•"""
    
    def test_strong_password(self):
        """æµ‹è¯•å¼ºå¯†ç """
        result = Validator.validate_password("SecurePass123!")
        assert result is True
    
    def test_weak_password_too_short(self):
        """æµ‹è¯•å¯†ç è¿‡çŸ­"""
        with pytest.raises(APIException):
            Validator.validate_password("Short1!")
    
    def test_password_missing_uppercase(self):
        """æµ‹è¯•ç¼ºå°‘å¤§å†™å­—æ¯"""
        with pytest.raises(APIException):
            Validator.validate_password("weakpass123!")
    
    def test_password_missing_special_char(self):
        """æµ‹è¯•ç¼ºå°‘ç‰¹æ®Šå­—ç¬¦"""
        with pytest.raises(APIException):
            Validator.validate_password("WeakPass123")


class TestUsernameValidator:
    """ç”¨æˆ·åéªŒè¯æµ‹è¯•"""
    
    def test_valid_username(self):
        """æµ‹è¯•æœ‰æ•ˆç”¨æˆ·å"""
        result = Validator.validate_username("john_doe")
        assert result == "john_doe"
    
    def test_username_too_short(self):
        """æµ‹è¯•ç”¨æˆ·åè¿‡çŸ­"""
        with pytest.raises(APIException):
            Validator.validate_username("ab")
    
    def test_username_starts_with_number(self):
        """æµ‹è¯•ç”¨æˆ·åä»¥æ•°å­—å¼€å¤´"""
        with pytest.raises(APIException):
            Validator.validate_username("123john")
    
    def test_username_with_special_char(self):
        """æµ‹è¯•ç”¨æˆ·ååŒ…å«ç‰¹æ®Šå­—ç¬¦"""
        with pytest.raises(APIException):
            Validator.validate_username("john@doe")


class TestPhoneValidator:
    """ç”µè¯å·ç éªŒè¯æµ‹è¯•"""
    
    def test_valid_phone(self):
        """æµ‹è¯•æœ‰æ•ˆç”µè¯å·ç """
        result = Validator.validate_phone("13800138000")
        assert result == "13800138000"
    
    def test_invalid_phone(self):
        """æµ‹è¯•æ— æ•ˆç”µè¯å·ç """
        with pytest.raises(APIException):
            Validator.validate_phone("12345678901")


class TestDateRangeValidator:
    """æ—¥æœŸèŒƒå›´éªŒè¯æµ‹è¯•"""
    
    def test_valid_date_range(self):
        """æµ‹è¯•æœ‰æ•ˆæ—¥æœŸèŒƒå›´"""
        start = datetime.now()
        end = start + timedelta(days=7)
        Validator.validate_date_range(start, end)
    
    def test_invalid_date_range_reversed(self):
        """æµ‹è¯•æ—¥æœŸèŒƒå›´é¢ å€’"""
        start = datetime.now()
        end = start - timedelta(days=7)
        with pytest.raises(APIException):
            Validator.validate_date_range(start, end)
    
    def test_date_range_too_short(self):
        """æµ‹è¯•æ—¥æœŸèŒƒå›´è¿‡çŸ­"""
        start = datetime.now()
        end = start + timedelta(days=2)
        with pytest.raises(APIException):
            Validator.validate_date_range(start, end, min_days=5)


class TestFileSizeValidator:
    """æ–‡ä»¶å¤§å°éªŒè¯æµ‹è¯•"""
    
    def test_valid_file_size(self):
        """æµ‹è¯•æœ‰æ•ˆæ–‡ä»¶å¤§å°"""
        size = 5 * 1024 * 1024  # 5MB
        Validator.validate_file_size(size, max_mb=10)
    
    def test_file_size_too_large(self):
        """æµ‹è¯•æ–‡ä»¶è¿‡å¤§"""
        size = 15 * 1024 * 1024  # 15MB
        with pytest.raises(APIException):
            Validator.validate_file_size(size, max_mb=10)
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### æ•°æ®æ¨¡å‹å®Œæ•´æ€§
- [ ] æ‰€æœ‰ä¸»è¦å®ä½“éƒ½æœ‰ Pydantic æ¨¡å‹
- [ ] æ‰€æœ‰å­—æ®µéƒ½æœ‰æ­£ç¡®çš„éªŒè¯è§„åˆ™
- [ ] Create/Update/Response æ¨¡å‹åŒºåˆ†æ¸…æ¥š
- [ ] åŒ…å«å®Œæ•´çš„éªŒè¯å™¨å’Œè‡ªå®šä¹‰éªŒè¯

### éªŒè¯å·¥å…·åº“å®Œæ•´æ€§
- [ ] è¦†ç›–å¸¸è§çš„æ•°æ®ç±»å‹éªŒè¯
- [ ] åŒ…å«ä¸šåŠ¡ç›¸å…³çš„éªŒè¯ï¼ˆé‚®ç®±ã€ç”µè¯ç­‰ï¼‰
- [ ] æ‰€æœ‰éªŒè¯éƒ½æŠ›å‡ºåˆé€‚çš„å¼‚å¸¸
- [ ] æœ‰è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯

### ä¸šåŠ¡è§„åˆ™å®Œæ•´æ€§
- [ ] å®šä¹‰äº†æ–‡ç« ç›¸å…³çš„ä¸šåŠ¡è§„åˆ™
- [ ] å®šä¹‰äº†ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡è§„åˆ™
- [ ] å®šä¹‰äº†åˆ†ç±»ç›¸å…³çš„ä¸šåŠ¡è§„åˆ™
- [ ] æ‰€æœ‰è§„åˆ™éƒ½èƒ½åœ¨æ•°æ®åº“ä¸­éªŒè¯

### é›†æˆå®Œæ•´æ€§
- [ ] æ‰€æœ‰è·¯ç”±éƒ½ä½¿ç”¨äº†éªŒè¯
- [ ] éªŒè¯é”™è¯¯èƒ½æ­£ç¡®è¿”å›ç»™å‰ç«¯
- [ ] æ•°æ®åº“ä¸ä¼šè¢«æ— æ•ˆæ•°æ®æ±¡æŸ“

### æµ‹è¯•å®Œæ•´æ€§
- [ ] æ‰€æœ‰éªŒè¯å‡½æ•°éƒ½æœ‰æµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] åŒ…å«æ­£å¸¸æƒ…å†µå’Œé”™è¯¯æƒ…å†µ
- [ ] æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡

---

## ğŸ“‚ æ–‡ä»¶æ¸…å•

éœ€è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶ï¼š

```
backend/
  â”œâ”€â”€ app/
  â”‚   â”œâ”€â”€ schemas/
  â”‚   â”‚   â”œâ”€â”€ articles.py (æ–°å»º/ä¿®æ”¹)
  â”‚   â”‚   â”œâ”€â”€ users.py (æ–°å»º/ä¿®æ”¹)
  â”‚   â”‚   â”œâ”€â”€ categories.py (æ–°å»º/ä¿®æ”¹)
  â”‚   â”‚   â””â”€â”€ sections.py (æ–°å»º/ä¿®æ”¹)
  â”‚   â”œâ”€â”€ validators/
  â”‚   â”‚   â”œâ”€â”€ __init__.py (æ–°å»º)
  â”‚   â”‚   â”œâ”€â”€ validators.py (æ–°å»º)
  â”‚   â”‚   â””â”€â”€ business_rules.py (æ–°å»º)
  â”‚   â””â”€â”€ routes/
  â”‚       â”œâ”€â”€ articles.py (ä¿®æ”¹ - é›†æˆéªŒè¯)
  â”‚       â”œâ”€â”€ users.py (ä¿®æ”¹)
  â”‚       â”œâ”€â”€ categories.py (ä¿®æ”¹)
  â”‚       â””â”€â”€ sections.py (ä¿®æ”¹)
  â”œâ”€â”€ tests/
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ test_validators.py (æ–°å»º)
  â”‚   â”œâ”€â”€ test_articles.py (ä¿®æ”¹ - æ·»åŠ éªŒè¯æµ‹è¯•)
  â”‚   â””â”€â”€ test_business_rules.py (æ–°å»º)
  â””â”€â”€ requirements.txt (ä¿®æ”¹ - æ·»åŠ  email-validator)
```

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Day 1 (å‘¨ä¸‰) - ä¸Šåˆ

1. **9:00-9:30**: åˆ›å»º Pydantic éªŒè¯æ¨¡å‹
2. **9:30-10:30**: åˆ›å»ºéªŒè¯å·¥å…·åº“
3. **10:30-11:30**: åˆ›å»ºä¸šåŠ¡è§„åˆ™éªŒè¯å™¨

### Day 1 (å‘¨ä¸‰) - ä¸‹åˆ

4. **13:00-14:00**: é›†æˆåˆ°ç°æœ‰è·¯ç”±
5. **14:00-15:00**: åˆ›å»ºæµ‹è¯•ç”¨ä¾‹
6. **15:00-16:00**: è¿è¡Œæµ‹è¯•å’Œä¿®å¤é—®é¢˜

### Day 2 (å‘¨å››) - ä¸Šåˆ

7. **9:00-10:00**: æ·»åŠ ç¼ºå¤±çš„éªŒè¯è§„åˆ™
8. **10:00-11:00**: æ–‡æ¡£å’Œæ³¨é‡Š
9. **11:00-12:00**: æœ€ç»ˆæµ‹è¯•å’Œæäº¤

---

## ğŸ¯ å®Œæˆåçš„é¢„æœŸæˆæœ

1. âœ… å®Œæ•´çš„æ•°æ®éªŒè¯å±‚
   - æ‰€æœ‰è¾“å…¥éƒ½è¢«éªŒè¯
   - éªŒè¯è§„åˆ™é›†ä¸­å®šä¹‰
   - æ˜“äºç»´æŠ¤å’Œæ‰©å±•

2. âœ… ç»Ÿä¸€çš„éªŒè¯å·¥å…·åº“
   - å¸¸è§éªŒè¯å‡½æ•°å¯å¤ç”¨
   - ä¸šåŠ¡éªŒè¯è§„åˆ™æ¸…æ™°
   - å‡å°‘ä»£ç é‡å¤

3. âœ… å®Œå–„çš„ä¸šåŠ¡è§„åˆ™å¼•æ“
   - ä¸šåŠ¡è§„åˆ™ä¸ä»£ç åˆ†ç¦»
   - è§„åˆ™æ˜“äºç†è§£å’Œä¿®æ”¹
   - å‡ºé”™æ—¶æœ‰æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯

4. âœ… é«˜è´¨é‡çš„æµ‹è¯•è¦†ç›–
   - æ‰€æœ‰éªŒè¯éƒ½è¢«æµ‹è¯•
   - èƒ½å¿«é€Ÿå®šä½é—®é¢˜
   - æå‡ä»£ç è´¨é‡

---

## ğŸ“ æ¥ä¸‹æ¥

å®Œæˆæœ¬ä»»åŠ¡åï¼š
1. Phase 1 å®Œæˆï¼Œå¯ä»¥å¼€å§‹ Phase 2 (B-4 è‡³ B-8)
2. å‰ç«¯å›¢é˜Ÿå¯ä»¥åŸºäºç¨³å®šçš„ API è¿›è¡Œé›†æˆ
3. å…¨ä½“å¯ä»¥è¿›è¡Œä»£ç å®¡æŸ¥

---

**ä»»åŠ¡ç¼–å·**: B-3  
**ä¼˜å…ˆçº§**: P0  
**çŠ¶æ€**: â³ å¾…å¯åŠ¨  
**é¢„è®¡å®Œæˆ**: 2025-11-14  
**æœ€åæ›´æ–°**: 2025-11-12
