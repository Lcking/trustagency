version: '3.8'

services:
  # ===== Frontend (Nginx) =====
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trustagency-frontend
    ports:
      - "80:80"
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./site:/usr/share/nginx/html:ro
      - ./nginx/logs:/var/log/nginx:rw
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/robots.txt"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - trustagency-net
    labels:
      - "app=trustagency"
      - "component=frontend"
      - "version=1.0"

  # ===== FastAPI Backend (SQLite) =====
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: trustagency-backend
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=sqlite:////app/trustagency.db
      - PYTHONUNBUFFERED=1
      - DEBUG=False
    volumes:
      - ./backend:/app:rw
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - trustagency-net
    labels:
      - "app=trustagency"
      - "component=backend"
      - "version=1.0"

# ===== Networks =====
networks:
  trustagency-net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-trustagency
